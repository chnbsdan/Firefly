---
import { musicPlayerConfig } from "@/config/musicConfig";
import { url } from "@/utils/url-utils";

const config = musicPlayerConfig;

// é¢„å…ˆç”Ÿæˆæœ¬åœ°èµ„æºè·¯å¾„ï¼Œç¡®ä¿åœ¨éæ ¹ç›®å½•éƒ¨ç½²æ—¶ä¹Ÿèƒ½æ­£ç¡®åŠ è½½
const aplayerCssPath = url("/assets/css/APlayer.min.css");
const aplayerCustomCssPath = url("/assets/css/APlayer.custom.css");
const aplayerJsPath = url("/assets/js/APlayer.min.js");

// MetingJS è·¯å¾„å¤„ç†
// å¦‚æœé…ç½®çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆä»¥ / å¼€å¤´ï¼‰ï¼Œä½¿ç”¨ url() å¤„ç†ä»¥ç¡®ä¿éæ ¹ç›®å½•éƒ¨ç½²æ—¶æ­£ç¡®
// å¦‚æœæ˜¯å®Œæ•´çš„ URLï¼ˆhttp/httpsï¼‰ï¼Œç›´æ¥ä½¿ç”¨
const metingJsPath = config.meting?.jsPath
  ? (config.meting.jsPath.startsWith("http://") || config.meting.jsPath.startsWith("https://"))
    ? config.meting.jsPath
    : url(config.meting.jsPath)
  : "https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"; // é»˜è®¤ CDN è·¯å¾„

// é¢„å¤„ç†æœ¬åœ°éŸ³ä¹åˆ—è¡¨çš„è·¯å¾„ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼‰
const processedLocalPlaylist = config.mode === "local" && config.local?.playlist
  ? config.local.playlist.map((song) => ({
      ...song,
      url: url(song.url),
      cover: song.cover ? url(song.cover) : undefined,
    }))
  : null;
---

{config.enable && (
  <>
    <!-- APlayer CSS -->
    <link
      rel="stylesheet"
      href={aplayerCssPath}
    />
    <link
      rel="stylesheet"
      href={aplayerCustomCssPath}
    />

    <!-- éŸ³ä¹èƒ¶å›Š -->
    <div id="music-capsule" class="music-capsule">
      <img id="capsule-cover" src="/assets/images/default-cover.jpg" alt="ä¸“è¾‘å°é¢" />
      <!-- é»‘èƒ¶å”±ç‰‡è‡‚ -->
      <div class="vinyl-arm">
        <div class="arm-base"></div>
        <div class="arm-rod"></div>
        <div class="arm-head"></div>
      </div>
    </div>

    <!-- ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º -->
    <div id="floating-lyrics" class="floating-lyrics">
      <div class="current-line"></div>
      <div class="next-line"></div>
    </div>

    <!-- å³é”®èœå• -->
    <ul id="right-menu" class="right-menu" role="menu" aria-hidden="true">
      <li id="menu-play" class="menu-item">
        <span class="menu-icon">â–¶</span>
        <span class="menu-text">æ’­æ”¾ / æš‚åœ</span>
      </li>
      <li id="menu-prev" class="menu-item">
        <span class="menu-icon">â®</span>
        <span class="menu-text">ä¸Šä¸€é¦–</span>
      </li>
      <li id="menu-next" class="menu-item">
        <span class="menu-icon">â­</span>
        <span class="menu-text">ä¸‹ä¸€é¦–</span>
      </li>
      <li class="menu-divider"></li>
      <li id="menu-volup" class="menu-item">
        <span class="menu-icon">ğŸ”Š</span>
        <span class="menu-text">éŸ³é‡ +</span>
      </li>
      <li id="menu-voldown" class="menu-item">
        <span class="menu-icon">ğŸ”‰</span>
        <span class="menu-text">éŸ³é‡ -</span>
      </li>
      <li class="menu-divider"></li>
      <li id="menu-lyrics" class="menu-item">
        <span class="menu-icon">ğŸ“œ</span>
        <span class="menu-text">æ˜¾ç¤ºæ­Œè¯</span>
      </li>
      <li id="menu-loop" class="menu-item">
        <span class="menu-icon">ğŸ”</span>
        <span class="menu-text">å¾ªç¯æ¨¡å¼</span>
      </li>
      <li class="menu-divider"></li>
      <li id="menu-support" class="menu-item">
        <span class="menu-icon">ğŸ’¡</span>
        <span class="menu-text">æŠ€æœ¯æ”¯æŒ</span>
      </li>
      <li id="menu-fullscreen" class="menu-item">
        <span class="menu-icon">ğŸ–¥ï¸</span>
        <span class="menu-text">å…¨å±æ¨¡å¼</span>
      </li>
      <li id="menu-close" class="menu-item">
        <span class="menu-icon">âŒ</span>
        <span class="menu-text">å…³é—­æ’­æ”¾å™¨</span>
      </li>
    </ul>

    <!-- éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ -->
    <div
      id="aplayer-container"
      class:mobile-hide={config.responsive?.mobile?.hide}
    >
      {config.mode === "meting" && config.meting ? (
        <!-- ä½¿ç”¨ MetingJS -->
        <meting-js
          server={config.meting.server || "netease"}
          type={config.meting.type || "playlist"}
          id={config.meting.id || ""}
          api={config.meting.api}
          auth={config.meting.auth}
          fixed={(config.player?.fixed ?? true) ? "true" : "false"}
          mini={(config.player?.mini ?? true) ? "true" : "false"}
          autoplay={config.player?.autoplay ? "true" : "false"}
          theme={config.player?.theme || "#b7daff"}
          loop={config.player?.loop || "all"}
          order={config.player?.order || "list"}
          preload={config.player?.preload || "auto"}
          volume={String(config.player?.volume ?? 0.7)}
          mutex={config.player?.mutex !== false ? "true" : "false"}
          lrc-type={String(config.player?.lrcType ?? 3)}
          list-folded={config.player?.listFolded ? "true" : "false"}
          list-max-height={config.player?.listMaxHeight || "340px"}
          storage-name={config.player?.storageName || "aplayer-setting"}
        />
      ) : config.mode === "local" && processedLocalPlaylist && processedLocalPlaylist.length > 0 ? (
        <!-- ä½¿ç”¨æœ¬åœ°éŸ³ä¹åˆ—è¡¨ -->
        <!-- å•ä¸ªéŸ³ä¹ä½¿ç”¨ MetingJSï¼Œå¤šä¸ªéŸ³ä¹ä½¿ç”¨ APlayer ç›´æ¥åˆå§‹åŒ– -->
        {processedLocalPlaylist.length === 1 ? (
          <meting-js
            name={processedLocalPlaylist?.[0]?.name || ""}
            artist={processedLocalPlaylist?.[0]?.artist || ""}
            url={processedLocalPlaylist?.[0]?.url || ""}
            cover={processedLocalPlaylist?.[0]?.cover}
            fixed={(config.player?.fixed ?? true) ? "true" : "false"}
            mini={(config.player?.mini ?? true) ? "true" : "false"}
            autoplay={config.player?.autoplay ? "true" : "false"}
            theme={config.player?.theme || "#b7daff"}
            loop={config.player?.loop || "all"}
            order={config.player?.order || "list"}
            preload={config.player?.preload || "auto"}
            volume={String(config.player?.volume ?? 0.7)}
            mutex={config.player?.mutex !== false ? "true" : "false"}
            lrc-type={processedLocalPlaylist[0]?.lrc ? "2" : "0"}
            list-folded={config.player?.listFolded ? "true" : "false"}
            list-max-height={config.player?.listMaxHeight || "340px"}
            storage-name={config.player?.storageName || "aplayer-setting"}
          >
            {processedLocalPlaylist?.[0]?.lrc && (
              <pre hidden>
                {processedLocalPlaylist[0].lrc}
              </pre>
            )}
          </meting-js>
        ) : (
          <!-- å¤šä¸ªæœ¬åœ°éŸ³ä¹ï¼Œä½¿ç”¨ APlayer ç›´æ¥åˆå§‹åŒ– -->
          <div id="local-aplayer"></div>
        )}
      ) : null}
    </div>
  </>
)}

<script define:vars={{ config, aplayerJsPath, metingJsPath, processedLocalPlaylist }} is:inline>
  // åŠ¨æ€åŠ è½½ APlayer å’Œ MetingJS
  (function() {
    if (!config.enable) return;
    
    // ç¡®ä¿åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œ
    if (typeof window === 'undefined') return;

    // èƒ¶å›Šæ’­æ”¾å™¨å’Œå³é”®èœå•åŠŸèƒ½
    let lyricsVisible = localStorage.getItem('lyricsVisible') !== 'false';
    let loopMode = localStorage.getItem('loopMode') || 'all';
    let isCapsuleMode = true; // é»˜è®¤èƒ¶å›Šæ¨¡å¼

    // åˆå§‹åŒ–èƒ¶å›Šå’Œèœå•åŠŸèƒ½
    function initCapsuleAndMenu() {
      const capsule = document.getElementById('music-capsule');
      const rightMenu = document.getElementById('right-menu');
      const floatingLyrics = document.getElementById('floating-lyrics');
      
      if (!capsule || !rightMenu) return;

      // èƒ¶å›Šç‚¹å‡»äº‹ä»¶
      capsule.addEventListener('click', togglePlayerVisibility);
      
      // åˆå§‹åŒ–å³é”®èœå•
      initRightClickMenu();
      
      // åˆå§‹åŒ–æ­Œè¯æ˜¾ç¤ºçŠ¶æ€
      updateLyricsVisibility();
    }

    // åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º
    function togglePlayerVisibility() {
      const container = document.getElementById('aplayer-container');
      const capsule = document.getElementById('music-capsule');
      
      if (!container || !capsule) return;
      
      isCapsuleMode = !isCapsuleMode;
      
      if (isCapsuleMode) {
        // åˆ‡æ¢åˆ°èƒ¶å›Šæ¨¡å¼
        container.style.display = 'none';
        capsule.style.display = 'flex';
      } else {
        // åˆ‡æ¢åˆ°æ’­æ”¾å™¨æ¨¡å¼
        container.style.display = '';
        capsule.style.display = 'none';
      }
    }

    // åˆå§‹åŒ–å³é”®èœå•
    function initRightClickMenu() {
      const rightMenu = document.getElementById('right-menu');
      const menuItems = {
        play: document.getElementById('menu-play'),
        prev: document.getElementById('menu-prev'),
        next: document.getElementById('menu-next'),
        volup: document.getElementById('menu-volup'),
        voldown: document.getElementById('menu-voldown'),
        lyrics: document.getElementById('menu-lyrics'),
        loop: document.getElementById('menu-loop'),
        support: document.getElementById('menu-support'),
        fullscreen: document.getElementById('menu-fullscreen'),
        close: document.getElementById('menu-close')
      };

      // æ˜¾ç¤ºèœå•
      function showMenuAt(clientX, clientY) {
        rightMenu.style.display = 'block';
        rightMenu.classList.remove('show');
        
        requestAnimationFrame(() => {
          const menuWidth = rightMenu.offsetWidth || 200;
          const menuHeight = rightMenu.offsetHeight || 300;
          
          // è®¡ç®—ä½ç½®ï¼Œé¿å…è¶…å‡ºå±å¹•
          let left = clientX;
          let top = clientY;
          
          if (left + menuWidth > window.innerWidth - 10) {
            left = window.innerWidth - menuWidth - 10;
          }
          if (left < 10) {
            left = 10;
          }
          
          if (top + menuHeight > window.innerHeight - 10) {
            top = clientY - menuHeight - 10;
          }
          if (top < 10) {
            top = 10;
          }
          
          rightMenu.style.left = left + 'px';
          rightMenu.style.top = top + 'px';
          
          const arrowLeft = Math.max(15, Math.min(clientX - left, menuWidth - 15));
          rightMenu.style.setProperty('--arrow-left', arrowLeft + 'px');
          
          rightMenu.classList.add('show');
          updateMenuStates();
        });
      }

      // éšè—èœå•
      function hideMenu() {
        rightMenu.classList.remove('show');
        setTimeout(() => {
          rightMenu.style.display = 'none';
        }, 200);
      }

      // æ›´æ–°èœå•çŠ¶æ€
      function updateMenuStates() {
        const aplayer = getAPlayerInstance();
        
        // æ›´æ–°æ­Œè¯èœå•æ–‡æœ¬
        menuItems.lyrics.querySelector('.menu-text').textContent = 
          lyricsVisible ? 'éšè—æ­Œè¯' : 'æ˜¾ç¤ºæ­Œè¯';
        
        // æ›´æ–°å¾ªç¯æ¨¡å¼èœå•æ–‡æœ¬
        const loopTexts = {
          'all': 'åˆ—è¡¨å¾ªç¯',
          'one': 'å•æ›²å¾ªç¯',
          'none': 'éšæœºæ’­æ”¾'
        };
        menuItems.loop.querySelector('.menu-text').textContent = 
          `å¾ªç¯: ${loopTexts[loopMode] || 'åˆ—è¡¨å¾ªç¯'}`;
        
        // æ›´æ–°æ’­æ”¾/æš‚åœçŠ¶æ€
        if (aplayer) {
          const isPlaying = !aplayer.paused;
          menuItems.play.querySelector('.menu-text').textContent = 
            isPlaying ? 'æš‚åœ' : 'æ’­æ”¾';
          menuItems.play.querySelector('.menu-icon').textContent = 
            isPlaying ? 'â¸' : 'â–¶';
        }
      }

      // èœå•åŠŸèƒ½å®ç°
      function togglePlay() {
        const aplayer = getAPlayerInstance();
        if (aplayer) {
          aplayer.toggle();
          setTimeout(updateMenuStates, 100);
        }
      }

      function prevSong() {
        const aplayer = getAPlayerInstance();
        if (aplayer) {
          aplayer.skipBack();
        }
      }

      function nextSong() {
        const aplayer = getAPlayerInstance();
        if (aplayer) {
          aplayer.skipForward();
        }
      }

      function volumeUp() {
        const aplayer = getAPlayerInstance();
        if (aplayer) {
          const newVolume = Math.min((aplayer.audio.volume || 0.7) + 0.1, 1);
          aplayer.volume(newVolume, true);
        }
      }

      function volumeDown() {
        const aplayer = getAPlayerInstance();
        if (aplayer) {
          const newVolume = Math.max((aplayer.audio.volume || 0.7) - 0.1, 0);
          aplayer.volume(newVolume, true);
        }
      }

      function toggleLyrics() {
        lyricsVisible = !lyricsVisible;
        localStorage.setItem('lyricsVisible', lyricsVisible.toString());
        updateLyricsVisibility();
        updateMenuStates();
      }

      function toggleLoop() {
        const aplayer = getAPlayerInstance();
        if (!aplayer) return;
        
        const modes = ['all', 'one', 'none'];
        const currentIndex = modes.indexOf(loopMode);
        loopMode = modes[(currentIndex + 1) % modes.length];
        
        localStorage.setItem('loopMode', loopMode);
        aplayer.loop = loopMode;
        updateMenuStates();
      }

      function openSupport() {
        window.open('https://1356666.xyz', '_blank');
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(() => {});
        } else {
          document.exitFullscreen().catch(() => {});
        }
      }

      function closePlayer() {
        const aplayer = getAPlayerInstance();
        if (aplayer) {
          aplayer.pause();
        }
        togglePlayerVisibility(); // åˆ‡æ¢å›èƒ¶å›Šæ¨¡å¼
      }

      // ç»‘å®šèœå•äº‹ä»¶
      menuItems.play.addEventListener('click', () => { togglePlay(); hideMenu(); });
      menuItems.prev.addEventListener('click', () => { prevSong(); hideMenu(); });
      menuItems.next.addEventListener('click', () => { nextSong(); hideMenu(); });
      menuItems.volup.addEventListener('click', () => { volumeUp(); hideMenu(); });
      menuItems.voldown.addEventListener('click', () => { volumeDown(); hideMenu(); });
      menuItems.lyrics.addEventListener('click', () => { toggleLyrics(); hideMenu(); });
      menuItems.loop.addEventListener('click', () => { toggleLoop(); hideMenu(); });
      menuItems.support.addEventListener('click', () => { openSupport(); hideMenu(); });
      menuItems.fullscreen.addEventListener('click', () => { toggleFullscreen(); hideMenu(); });
      menuItems.close.addEventListener('click', () => { closePlayer(); hideMenu(); });

      // å…¨å±€å³é”®äº‹ä»¶
      document.addEventListener('contextmenu', function(e) {
        const target = e.target;
        const isOnCapsule = target.closest('#music-capsule');
        const isOnPlayer = target.closest('.aplayer') || target.closest('#aplayer-container');
        
        if (isOnCapsule || isOnPlayer) {
          e.preventDefault();
          showMenuAt(e.clientX, e.clientY);
        }
      });

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
      document.addEventListener('click', function(e) {
        if (!rightMenu.contains(e.target)) {
          hideMenu();
        }
      });

      // ESCé”®éšè—èœå•
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hideMenu();
        }
      });
    }

    // æ›´æ–°æ­Œè¯æ˜¾ç¤ºçŠ¶æ€
    function updateLyricsVisibility() {
      const floatingLyrics = document.getElementById('floating-lyrics');
      if (floatingLyrics) {
        if (lyricsVisible) {
          floatingLyrics.classList.add('show');
        } else {
          floatingLyrics.classList.remove('show');
        }
      }
    }

    // è·å– APlayer å®ä¾‹
    function getAPlayerInstance() {
      const metingElement = document.querySelector('meting-js');
      if (metingElement?.aplayer) return metingElement.aplayer;
      
      const localPlayer = document.getElementById('local-aplayer');
      if (localPlayer?.aplayer) return localPlayer.aplayer;
      
      const aplayerElements = document.querySelectorAll('.aplayer');
      for (let element of aplayerElements) {
        if (element.aplayer) return element.aplayer;
      }
      
      return null;
    }

    // åˆå§‹åŒ–æ’­æ”¾å™¨çŠ¶æ€ç›‘å¬
    function initPlayerListener() {
      const aplayer = getAPlayerInstance();
      if (!aplayer) {
        setTimeout(initPlayerListener, 500);
        return;
      }

      const capsule = document.getElementById('music-capsule');
      const capsuleCover = document.getElementById('capsule-cover');
      const floatingLyrics = document.getElementById('floating-lyrics');
      const currentLineEl = floatingLyrics?.querySelector('.current-line');
      const nextLineEl = floatingLyrics?.querySelector('.next-line');

      let currentLyric = '';

      // ç›‘å¬æ’­æ”¾çŠ¶æ€
      aplayer.on('play', function() {
        if (capsule) capsule.classList.add('playing');
        updateCover();
      });
      
      aplayer.on('pause', function() {
        if (capsule) capsule.classList.remove('playing');
      });
      
      aplayer.on('ended', function() {
        if (capsule) capsule.classList.remove('playing');
        updateLyrics('', '');
      });
      
      aplayer.on('loadeddata', updateCover);
      aplayer.on('listswitch', updateCover);

      // æ›´æ–°èƒ¶å›Šå°é¢
      function updateCover() {
        try {
          const currentAudio = aplayer.list.audios[aplayer.list.index];
          if (currentAudio && currentAudio.cover && capsuleCover) {
            capsuleCover.src = currentAudio.cover;
          }
        } catch(e) {
          console.log('æ›´æ–°å°é¢å¤±è´¥:', e);
        }
      }

      // æ›´æ–°æ­Œè¯æ˜¾ç¤º
      function updateLyrics(current, next) {
        if (!currentLineEl || !nextLineEl) return;
        
        currentLineEl.textContent = current || '';
        nextLineEl.textContent = next || '';
        
        if (current && lyricsVisible) {
          floatingLyrics.classList.add('show');
        } else {
          floatingLyrics.classList.remove('show');
        }
      }

      // ç›‘å¬æ­Œè¯å˜åŒ–
      function startLyricsListener() {
        setInterval(() => {
          if (!lyricsVisible) return;
          
          const lrcContainer = document.querySelector('.aplayer-lrc');
          if (!lrcContainer) return;
          
          const currentLrc = lrcContainer.querySelector('p.aplayer-lrc-current');
          const allLrcLines = lrcContainer.querySelectorAll('p');
          
          if (currentLrc && currentLrc.textContent.trim()) {
            const currentText = currentLrc.textContent.trim();
            let nextText = '';
            
            for (let i = 0; i < allLrcLines.length; i++) {
              if (allLrcLines[i] === currentLrc && i < allLrcLines.length - 1) {
                nextText = allLrcLines[i + 1].textContent.trim();
                break;
              }
            }
            
            if (currentText !== currentLyric) {
              currentLyric = currentText;
              updateLyrics(currentText, nextText);
            }
          } else {
            updateLyrics('', '');
            currentLyric = '';
          }
        }, 100);
      }

      // å¼€å§‹ç›‘å¬æ­Œè¯
      startLyricsListener();
    }

    // ä½ çš„åŸæœ‰ APlayer åŠ è½½ä»£ç ä¿æŒä¸å˜
    // åŠ è½½ APlayer JS
    function loadAPlayer() {
      return new Promise((resolve) => {
        if (window.APlayer) {
          resolve(window.APlayer);
          return;
        }

        const aplayerScript = document.createElement("script");
        aplayerScript.src = aplayerJsPath;
        aplayerScript.async = true;
        aplayerScript.onload = () => resolve(window.APlayer);
        aplayerScript.onerror = () => {
          console.error("Failed to load APlayer");
          resolve(null);
        };
        document.head.appendChild(aplayerScript);
      });
    }

    // å…¨å±€ç”¨æˆ·äº¤äº’çŠ¶æ€
    if (!window.hasMusicInteracted) {
      window.hasMusicInteracted = false;
    }
    
    function tryAutoplay(aplayer) {
      if (!config.player?.autoplay) return;
      
      if (window.hasMusicInteracted) {
        if (aplayer && aplayer.paused) {
          const playPromise = aplayer.play();
          if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch((error) => {
              if (error.name !== 'NotAllowedError') {
                console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error.name);
              }
            });
          }
        }
      } else {
        const enableAutoplay = () => {
          if (window.hasMusicInteracted) return;
          window.hasMusicInteracted = true;
          
          if (aplayer && aplayer.paused) {
            const playPromise = aplayer.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch((error) => {
                if (error.name !== 'NotAllowedError') {
                  console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error.name);
                }
              });
            }
          }
        };
        
        ['click', 'keydown', 'touchstart', 'scroll'].forEach(eventType => {
          document.addEventListener(eventType, enableAutoplay, { 
            once: true, 
            passive: true 
          });
        });
      }
    }

    // æ£€æŸ¥ MetingJS å…ƒç´ æ˜¯å¦æˆåŠŸåŠ è½½äº†éŸ³ä¹
    function checkMetingSuccess(metingElement, timeout = 5000) {
      return new Promise((resolve) => {
        const startTime = Date.now();
        
        const checkSuccess = setInterval(() => {
          const aplayer = metingElement?.aplayer;
          if (aplayer && aplayer.list && aplayer.list.audios && aplayer.list.audios.length > 0) {
            clearInterval(checkSuccess);
            resolve(true);
            return;
          }
          
          if (Date.now() - startTime >= timeout) {
            clearInterval(checkSuccess);
            resolve(false);
          }
        }, 100);
      });
    }

    // é‡æ–°åˆ›å»º MetingJS å…ƒç´ ä»¥ä½¿ç”¨æ–°çš„ API
    function recreateMetingElement(container, apiUrl, config) {
      const oldElement = container.querySelector('meting-js');
      if (oldElement) {
        if (oldElement.aplayer) {
          try {
            oldElement.aplayer.destroy();
          } catch (e) {
            console.warn('é”€æ¯æ—§ APlayer å®ä¾‹æ—¶å‡ºé”™:', e);
          }
        }
        oldElement.remove();
      }
      
      const newElement = document.createElement('meting-js');
      newElement.setAttribute('server', config.meting?.server || 'netease');
      newElement.setAttribute('type', config.meting?.type || 'playlist');
      newElement.setAttribute('id', config.meting?.id || '');
      newElement.setAttribute('api', apiUrl);
      if (config.meting?.auth) {
        newElement.setAttribute('auth', config.meting.auth);
      }
      newElement.setAttribute('fixed', (config.player?.fixed ?? true) ? 'true' : 'false');
      newElement.setAttribute('mini', (config.player?.mini ?? true) ? 'true' : 'false');
      newElement.setAttribute('autoplay', config.player?.autoplay ? 'true' : 'false');
      newElement.setAttribute('theme', config.player?.theme || '#b7daff');
      newElement.setAttribute('loop', config.player?.loop || 'all');
      newElement.setAttribute('order', config.player?.order || 'list');
      newElement.setAttribute('preload', config.player?.preload || 'auto');
      newElement.setAttribute('volume', String(config.player?.volume ?? 0.7));
      newElement.setAttribute('mutex', config.player?.mutex !== false ? 'true' : 'false');
      newElement.setAttribute('lrc-type', String(config.player?.lrcType ?? 3));
      newElement.setAttribute('list-folded', config.player?.listFolded ? 'true' : 'false');
      newElement.setAttribute('list-max-height', config.player?.listMaxHeight || '340px');
      newElement.setAttribute('storage-name', config.player?.storageName || 'aplayer-setting');
      
      container.appendChild(newElement);
      return newElement;
    }

    // å¤„ç†ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—
    function handleMobileVisibility(aplayer) {
      if (!aplayer || !aplayer.container) return;
      
      const shouldHide = config.responsive?.mobile?.hide === true;
      const breakpoint = config.responsive?.mobile?.breakpoint || 768;
      const isMobile = window.innerWidth <= breakpoint;
      
      if (shouldHide && isMobile) {
        aplayer.container.style.display = 'none';
        aplayer.container.classList.add('mobile-hide');
        
        const container = document.getElementById('aplayer-container');
        if (container) {
          container.style.display = 'none';
          container.classList.add('mobile-hide');
        }
      } else {
        aplayer.container.style.display = '';
        aplayer.container.classList.remove('mobile-hide');
        
        const container = document.getElementById('aplayer-container');
        if (container) {
          container.style.display = '';
          container.classList.remove('mobile-hide');
        }
      }
    }
    
    // åˆå§‹åŒ–æ—¶å¤„ç†å®¹å™¨çš„ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—
    function initContainerMobileVisibility() {
      const container = document.getElementById('aplayer-container');
      if (!container) return;
      
      const shouldHide = config.responsive?.mobile?.hide === true;
      const breakpoint = config.responsive?.mobile?.breakpoint || 768;
      const isMobile = window.innerWidth <= breakpoint;
      
      if (shouldHide && isMobile) {
        container.style.display = 'none';
        container.classList.add('mobile-hide');
      } else {
        container.style.display = '';
        container.classList.remove('mobile-hide');
      }
      
      const resizeHandler = () => {
        const nowIsMobile = window.innerWidth <= breakpoint;
        if (shouldHide && nowIsMobile) {
          container.style.display = 'none';
          container.classList.add('mobile-hide');
        } else {
          container.style.display = '';
          container.classList.remove('mobile-hide');
        }
      };
      window.addEventListener('resize', resizeHandler);
    }

    // åˆå§‹åŒ– MetingJS å…ƒç´ å¹¶è®¾ç½®æ’­æ”¾å™¨
    function setupMetingElement(metingElement) {
      return new Promise((resolve) => {
        const checkAPlayer = setInterval(() => {
          const aplayer = metingElement.aplayer;
          if (aplayer && aplayer.container) {
            clearInterval(checkAPlayer);
            
            const updatePlayingState = () => {
              if (aplayer.container) {
                const isPlaying = !aplayer.paused;
                aplayer.container.setAttribute('data-playing', String(isPlaying));
                if (isPlaying) {
                  aplayer.container.classList.add('aplayer-playing');
                } else {
                  aplayer.container.classList.remove('aplayer-playing');
                }
              }
            };
            
            if (aplayer.audio) {
              aplayer.audio.addEventListener('play', updatePlayingState);
              aplayer.audio.addEventListener('pause', updatePlayingState);
              aplayer.audio.addEventListener('ended', updatePlayingState);
            }
            
            aplayer.container.setAttribute('data-positioned', 'right');
            requestAnimationFrame(() => {
              if (aplayer.container) {
                aplayer.container.style.right = '0';
                aplayer.container.style.left = 'unset';
                
                updatePlayingState();
                handleMobileVisibility(aplayer);
                
                const resizeHandler = () => handleMobileVisibility(aplayer);
                window.addEventListener('resize', resizeHandler);
                
                setTimeout(() => {
                  aplayer.container.setAttribute('data-initialized', 'true');
                  
                  if (config.player?.lrcHidden && aplayer.lrc) {
                    aplayer.lrc.hide();
                    const lrcButton = aplayer.container.querySelector('.aplayer-icon-lrc');
                    if (lrcButton) {
                      lrcButton.classList.add('aplayer-icon-lrc-inactivity');
                    }
                  }
                  
                  if (config.player?.autoplay && aplayer.paused) {
                    tryAutoplay(aplayer);
                  }

                  // åˆå§‹åŒ–èƒ¶å›Šå’Œèœå•åŠŸèƒ½
                  initCapsuleAndMenu();
                  // åˆå§‹åŒ–æ’­æ”¾å™¨ç›‘å¬
                  initPlayerListener();
                }, 200);
              }
            });
            
            resolve(true);
          }
        }, 50);
        
        setTimeout(() => {
          clearInterval(checkAPlayer);
          resolve(false);
        }, 10000);
      });
    }

    // ä½¿ç”¨å¤‡ç”¨ API é‡è¯•åŠ è½½
    async function retryWithFallbackAPI(container, fallbackApis, currentIndex = 0) {
      if (currentIndex >= fallbackApis.length) {
        console.error('æ‰€æœ‰ API éƒ½å¤±è´¥äº†ï¼Œæ— æ³•åŠ è½½éŸ³ä¹æ’­æ”¾å™¨');
        return null;
      }
      
      const fallbackApi = fallbackApis[currentIndex];
      console.log(`å°è¯•ä½¿ç”¨å¤‡ç”¨ API ${currentIndex + 1}/${fallbackApis.length}: ${fallbackApi}`);
      
      const server = config.meting?.server || 'netease';
      const type = config.meting?.type || 'playlist';
      const id = config.meting?.id || '';
      
      let apiUrl = fallbackApi
        .replace(':server', server)
        .replace(':type', type)
        .replace(':id', id);
      
      window.meting_api = apiUrl;
      
      const newElement = recreateMetingElement(container, apiUrl, config);
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const success = await checkMetingSuccess(newElement, 5000);
      
      if (success) {
        console.log(`å¤‡ç”¨ API ${currentIndex + 1} æˆåŠŸåŠ è½½éŸ³ä¹`);
        return newElement;
      } else {
        return retryWithFallbackAPI(container, fallbackApis, currentIndex + 1);
      }
    }

    // åŠ è½½ MetingJS
    function loadMetingJS() {
      return new Promise((resolve) => {
        if (window.customElements?.get("meting-js")) {
          resolve(true);
          return;
        }

        const metingScript = document.createElement("script");
        metingScript.src = metingJsPath;
        metingScript.async = true;
        metingScript.onload = async () => {
          await new Promise(resolve => setTimeout(resolve, 100));
          
          const container = document.getElementById('aplayer-container');
          if (!container) {
            resolve(false);
            return;
          }
          
          let metingElement = container.querySelector('meting-js');
          
          if (config.mode === "meting" && config.meting?.api && metingElement) {
            const server = config.meting.server || 'netease';
            const type = config.meting.type || 'playlist';
            const id = config.meting.id || '';
            
            let mainApiUrl = config.meting.api
              .replace(':server', server)
              .replace(':type', type)
              .replace(':id', id)
              .replace(':r', Math.random().toString());
            
            window.meting_api = mainApiUrl;
            
            console.log('å°è¯•ä½¿ç”¨ä¸» API:', mainApiUrl);
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const mainApiSuccess = await checkMetingSuccess(metingElement, 5000);
            
            if (!mainApiSuccess && config.meting.fallbackApis && config.meting.fallbackApis.length > 0) {
              console.warn('ä¸» API å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ API');
              const newElement = await retryWithFallbackAPI(container, config.meting.fallbackApis);
              if (newElement) {
                metingElement = newElement;
              }
            }
          }
          
          if (metingElement) {
            await setupMetingElement(metingElement);
          }
          
          resolve(true);
        };
        metingScript.onerror = () => {
          console.error("Failed to load MetingJS");
          resolve(false);
        };
        document.head.appendChild(metingScript);
      });
    }

    // åˆå§‹åŒ–æœ¬åœ°éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå¤šä¸ªéŸ³ä¹ï¼‰
    async function initLocalPlayer() {
      if (
        config.mode !== "local" ||
        !processedLocalPlaylist ||
        processedLocalPlaylist.length <= 1
      ) {
        return;
      }

      const APlayerClass = await loadAPlayer();
      if (!APlayerClass) return;

      const container = document.getElementById("local-aplayer");
      if (!container) return;

      const audioList = processedLocalPlaylist.map((song) => ({
        name: song.name,
        artist: song.artist,
        url: song.url,
        cover: song.cover,
        lrc: song.lrc || undefined,
        type: "auto",
      }));

      const aplayerOptions = {
        container: container,
        audio: audioList,
        mutex: config.player?.mutex !== false,
        lrcType: config.player?.lrcType !== undefined ? config.player.lrcType : 0,
        fixed: config.player?.fixed ?? true,
        mini: config.player?.mini ?? true,
        autoplay: config.player?.autoplay || false,
        theme: config.player?.theme || "#b7daff",
        loop: config.player?.loop || "all",
        order: config.player?.order || "list",
        preload: config.player?.preload || "auto",
        volume: config.player?.volume || 0.7,
        listFolded: config.player?.listFolded || false,
        listMaxHeight: config.player?.listMaxHeight || "340px",
        storageName: config.player?.storageName || "aplayer-setting",
      };

      try {
        const aplayer = new APlayerClass(aplayerOptions);
        
        const updatePlayingState = () => {
          if (aplayer.container) {
            const isPlaying = !aplayer.paused;
            aplayer.container.setAttribute('data-playing', String(isPlaying));
            if (isPlaying) {
              aplayer.container.classList.add('aplayer-playing');
            } else {
              aplayer.container.classList.remove('aplayer-playing');
            }
          }
        };
        
        if (aplayer.audio) {
          aplayer.audio.addEventListener('play', updatePlayingState);
          aplayer.audio.addEventListener('pause', updatePlayingState);
          aplayer.audio.addEventListener('ended', updatePlayingState);
        }
        
        if (aplayer.container) {
          aplayer.container.setAttribute('data-positioned', 'right');
          requestAnimationFrame(() => {
            if (aplayer.container) {
              aplayer.container.style.right = '0';
              aplayer.container.style.left = 'unset';
              
              updatePlayingState();
              handleMobileVisibility(aplayer);
              
              const resizeHandler = () => handleMobileVisibility(aplayer);
              window.addEventListener('resize', resizeHandler);
              
              setTimeout(() => {
                aplayer.container.setAttribute('data-initialized', 'true');
                
                if (config.player?.lrcHidden && aplayer.lrc) {
                  aplayer.lrc.hide();
                  const lrcButton = aplayer.container.querySelector('.aplayer-icon-lrc');
                  if (lrcButton) {
                    lrcButton.classList.add('aplayer-icon-lrc-inactivity');
                  }
                }
                
                if (config.player?.autoplay && aplayer.paused) {
                  tryAutoplay(aplayer);
                }

                // åˆå§‹åŒ–èƒ¶å›Šå’Œèœå•åŠŸèƒ½
                initCapsuleAndMenu();
                // åˆå§‹åŒ–æ’­æ”¾å™¨ç›‘å¬
                initPlayerListener();
              }, 100);
            }
          });
        }
      } catch (error) {
        console.error("Failed to initialize APlayer:", error);
      }
    }

    // åˆå§‹åŒ–å®¹å™¨çš„ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initContainerMobileVisibility);
    } else {
      initContainerMobileVisibility();
    }
    
    // å¦‚æœä½¿ç”¨ Meting æ¨¡å¼ï¼ŒåŠ è½½ MetingJS
    if (config.mode === "meting") {
      loadAPlayer().then(() => {
        loadMetingJS();
      });
    } else if (config.mode === "local") {
      if (processedLocalPlaylist && processedLocalPlaylist.length > 1) {
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initLocalPlayer);
        } else {
          initLocalPlayer();
        }
      } else {
        loadAPlayer().then(() => {
          loadMetingJS();
        });
      }
    }
  })();
</script>

<style>
  #aplayer-container {
    position: relative;
    z-index: 1000;
  }

  /* ç¡®ä¿æ’­æ”¾å™¨åœ¨å›ºå®šæ¨¡å¼ä¸‹æ­£ç¡®æ˜¾ç¤º */
  #aplayer-container .aplayer-fixed {
    z-index: 9999;
  }

  /* ç¦ç”¨ APlayer åˆå§‹åŒ–æ—¶çš„è¿‡æ¸¡åŠ¨ç”»ï¼Œé¿å…æ”¶ç¼©æ•ˆæœ */
  #aplayer-container .aplayer.aplayer-fixed {
    animation: none !important;
  }
  
  #aplayer-container .aplayer.aplayer-fixed .aplayer-body {
    animation: none !important;
    transition: none !important;
  }
  
  /* ç¡®ä¿æ’­æ”¾å™¨åˆå§‹åŒ–æ—¶å°±åœ¨å³ä¾§ä½ç½® */
  #aplayer-container .aplayer.aplayer-fixed[data-positioned="right"] {
    right: 0 !important;
    left: unset !important;
  }

  /* ç§»åŠ¨ç«¯éšè— - é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ ç±» */
  .aplayer-fixed.mobile-hide {
    display: none !important;
  }
  
  /* ç§»åŠ¨ç«¯éšè—å®¹å™¨ */
  #aplayer-container.mobile-hide {
    display: none !important;
  }

  /* éŸ³ä¹èƒ¶å›Šæ ·å¼ */
  .music-capsule {
    position: fixed;
    left: 22px;
    bottom: 96px;
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 30000;
    background: radial-gradient(circle at 30% 30%, #00c3ff, #0061ff);
    box-shadow: 0 8px 28px rgba(0, 180, 255, 0.12);
    transition: all 0.3s ease;
  }

  .music-capsule:hover {
    transform: scale(1.05);
  }

  .music-capsule img {
    width: 64%;
    height: 64%;
    border-radius: 50%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .music-capsule.playing {
    background: radial-gradient(circle at 30% 30%, #ff9500, #ff5e00);
    box-shadow: 0 8px 28px rgba(255, 140, 0, 0.28);
  }

  .music-capsule.playing img {
    animation: spin 6s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0) }
    to { transform: rotate(360deg) }
  }

  /* é»‘èƒ¶å”±ç‰‡è‡‚ */
  .vinyl-arm {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    width: 90px;
    height: 70px;
    z-index: 10;
    pointer-events: none;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .music-capsule.playing .vinyl-arm {
    opacity: 1;
  }

  .arm-base {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 16px;
    height: 25px;
    background: linear-gradient(135deg, #8b8b8b, #4a4a4a, #8b8b8b);
    border-radius: 4px 4px 2px 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    border: 1px solid #5a5a5a;
  }

  .arm-rod {
    position: absolute;
    top: 25px;
    left: 50%;
    width: 3px;
    height: 45px;
    background: linear-gradient(to bottom, #c0c0c0, #808080, #505050);
    transform-origin: top center;
    transform: translateX(-50%) rotate(-25deg);
    transition: transform 0.8s cubic-bezier(0.34, 1.2, 0.64, 1);
    border-radius: 1px;
  }

  .music-capsule.playing .vinyl-arm .arm-rod {
    transform: translateX(-50%) rotate(25deg);
  }

  .arm-head {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 12px;
    height: 12px;
    background: linear-gradient(135deg, #333, #000);
    border-radius: 50%;
    transform: translateX(-50%);
    box-shadow: 0 1px 6px rgba(0,0,0,0.6), 
          inset 0 1px 1px rgba(255,255,255,0.2);
    border: 1px solid #000;
  }

  /* ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º */
  .floating-lyrics {
    position: fixed;
    left: 100px;
    bottom: 50px;
    text-align: left;
    z-index: 99999;
    color: #ff8c00;
    font-size: 18px;
    font-weight: bold;
    text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9);
    background: rgba(255, 255, 255, 0.10);
    padding: 15px 20px;
    border-radius: 12px;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    max-width: 400px;
    opacity: 0;
    transition: opacity 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    pointer-events: none;
  }

  .floating-lyrics.show {
    opacity: 1;
  }

  .floating-lyrics .current-line {
    color: #ff4500;
    font-size: 30px;
    margin-bottom: 8px;
    font-weight: bold;
    min-height: 24px;
  }

  .floating-lyrics .next-line {
    color: #ff8c00;
    font-size: 14px;
    opacity: 0.8;
    min-height: 18px;
  }

  /* å³é”®èœå•æ ·å¼ */
  .right-menu {
    position: fixed;
    display: none;
    z-index: 40000;
    min-width: 200px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    color: #fff;
    border-radius: 12px;
    box-shadow: 
      0 10px 40px rgba(0, 0, 0, 0.3),
      0 0 0 1px rgba(255, 255, 255, 0.1);
    padding: 8px 0;
    opacity: 0;
    transform: scale(0.95) translateY(-10px);
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-family: system-ui, -apple-system, sans-serif;
    user-select: none;
  }

  .right-menu.show {
    display: block;
    opacity: 1;
    transform: scale(1) translateY(0);
  }

  .menu-item {
    list-style: none;
    padding: 10px 16px;
    cursor: pointer;
    white-space: nowrap;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .menu-item:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #f97316;
  }

  .menu-item:active {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(0.98);
  }

  .menu-icon {
    font-size: 16px;
    width: 20px;
    text-align: center;
    opacity: 0.9;
  }

  .menu-text {
    flex: 1;
  }

  .menu-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.2);
    margin: 6px 12px;
    list-style: none;
  }

  /* èœå•ç®­å¤´ */
  .right-menu::before {
    content: "";
    position: absolute;
    top: -6px;
    left: var(--arrow-left, 50%);
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .music-capsule {
      left: 18px;
      bottom: 22px;
      width: 60px;
      height: 60px;
    }
    
    .floating-lyrics {
      left: 90px;
      bottom: 30px;
      max-width: 250px;
      font-size: 16px;
    }
    
    .floating-lyrics .current-line {
      font-size: 18px;
    }
    
    .floating-lyrics .next-line {
      font-size: 12px;
    }
    
    .right-menu {
      min-width: 180px;
      font-size: 13px;
    }
    
    .menu-item {
      padding: 12px 16px;
    }
  }
</style>
