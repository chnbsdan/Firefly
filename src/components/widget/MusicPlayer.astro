---
// src/components/widget/MusicPlayer.astro
import type { MusicPlayerConfig } from "../../types/config";
import { musicPlayerConfig } from "../../config/musicConfig";
import { url } from "../../utils/url-utils";

const config = musicPlayerConfig;

// é¢„å…ˆç”Ÿæˆæœ¬åœ°èµ„æºè·¯å¾„ï¼Œç¡®ä¿åœ¨éæ ¹ç›®å½•éƒ¨ç½²æ—¶ä¹Ÿèƒ½æ­£ç¡®åŠ è½½
const aplayerCssPath = url("/assets/css/APlayer.min.css");
const aplayerCustomCssPath = url("/assets/css/APlayer.custom.css");
const aplayerJsPath = url("/assets/js/APlayer.min.js");

// MetingJS è·¯å¾„å¤„ç†
const metingJsPath = config.meting?.jsPath
  ? (config.meting.jsPath.startsWith("http://") || config.meting.jsPath.startsWith("https://"))
    ? config.meting.jsPath
    : url(config.meting.jsPath)
  : "https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js";

// é¢„å¤„ç†æœ¬åœ°éŸ³ä¹åˆ—è¡¨çš„è·¯å¾„
const processedLocalPlaylist = config.mode === "local" && config.local?.playlist
  ? config.local.playlist.map((song) => ({
      ...song,
      url: url(song.url),
      cover: song.cover ? url(song.cover) : undefined,
    }))
  : null;
---

{config.enable && (
  <>
    <!-- APlayer CSS -->
    <link rel="stylesheet" href={aplayerCssPath} />
    <link rel="stylesheet" href={aplayerCustomCssPath} />

    <!-- éŸ³ä¹èƒ¶å›Š -->
    <div id="music-capsule" class="music-capsule" title="ç‚¹å‡»å±•å¼€æ’­æ”¾å™¨">
      <img id="capsule-cover" src="https://p2.music.126.net/4HGEnXVexEfF2M4WdDdfrQ==/109951166354363385.jpg" alt="ä¸“è¾‘å°é¢" />
      <!-- é»‘èƒ¶å”±ç‰‡æ»‘åŠ¨æ† -->
      <div class="vinyl-arm">
        <div class="arm-base"></div>
        <div class="arm-rod"></div>
        <div class="arm-head"></div>
      </div>
    </div>

    <!-- ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º -->
    <div id="floating-lyrics" class="floating-lyrics">
      <div class="current-line"></div>
      <div class="next-line"></div>
    </div>

    <!-- æ’­æ”¾å™¨å®¹å™¨ -->
    <div id="player-wrap" aria-hidden="true">
      <div id="aplayer-container" class:mobile-hide={config.responsive?.mobile?.hide}></div>
    </div>

    <!-- å³é”®èœå• -->
    <ul id="right-menu" role="menu" aria-hidden="true">
      <li id="menu-play">â–¶ æ’­æ”¾ / æš‚åœ</li>
      <li id="menu-prev">â® ä¸Šä¸€é¦–</li>
      <li id="menu-next">â­ ä¸‹ä¸€é¦–</li>
      <li id="menu-volup">ğŸ”Š éŸ³é‡ +</li>
      <li id="menu-voldown">ğŸ”‰ éŸ³é‡ -</li>
      <li id="menu-lyrics">ğŸ“œ æ˜¾ç¤º/éšè—æ­Œè¯</li>
      <li id="menu-support">ğŸ’¡ æŠ€æœ¯æ”¯æŒ</li>
      <li id="menu-fullscreen">ğŸ–¥ï¸ å…¨å±æ¨¡å¼</li>
      <li id="menu-close">âŒ å…³é—­æ’­æ”¾å™¨</li>
    </ul>

    <!-- éŸ³ä¹æ’­æ”¾å™¨è„šæœ¬ -->
    <script is:inline define:vars={{ config: JSON.stringify(config), aplayerJsPath, metingJsPath, processedLocalPlaylist: JSON.stringify(processedLocalPlaylist) }}>
      (function() {
        if (!{config.enable}) return;
        if (typeof window === 'undefined') return;

        // çŠ¶æ€å˜é‡
        let lyricsVisible = localStorage.getItem('lyricsVisible') !== 'false';
        let metingEl = null;
        let aplayer = null;
        let lyricsInterval = null;
        let currentLyric = '';

        // DOM å¼•ç”¨
        const capsule = document.getElementById('music-capsule');
        const capsuleCover = document.getElementById('capsule-cover');
        const playerWrap = document.getElementById('player-wrap');
        const aplayerContainer = document.getElementById('aplayer-container');
        const rightMenu = document.getElementById('right-menu');
        const floatingLyrics = document.getElementById('floating-lyrics');
        const currentLineEl = floatingLyrics?.querySelector('.current-line');
        const nextLineEl = floatingLyrics?.querySelector('.next-line');

        // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
        function initMeting(){
          if (aplayer) return Promise.resolve(aplayer);
          return new Promise((resolve, reject) => {
            if (metingEl && metingEl.aplayer) {
              aplayer = metingEl.aplayer;
              bindAPlayerEvents(aplayer);
              return resolve(aplayer);
            }

            // åˆ›å»º meting-js å…ƒç´ 
            aplayerContainer.innerHTML = '';
            
            const config = {config: JSON.parse('{JSON.stringify(config)}')};
            const processedLocalPlaylist = {processedLocalPlaylist: JSON.parse('{JSON.stringify(processedLocalPlaylist)}')};
            
            if (config.mode === "meting" && config.meting) {
              metingEl = document.createElement('meting-js');
              metingEl.setAttribute('server', config.meting.server || 'netease');
              metingEl.setAttribute('type', config.meting.type || 'playlist');
              metingEl.setAttribute('id', config.meting.id || '');
              if (config.meting.api) metingEl.setAttribute('api', config.meting.api);
              if (config.meting.auth) metingEl.setAttribute('auth', config.meting.auth);
              metingEl.setAttribute('fixed', (config.player?.fixed ?? true) ? 'true' : 'false');
              metingEl.setAttribute('mini', (config.player?.mini ?? true) ? 'true' : 'false');
              metingEl.setAttribute('autoplay', config.player?.autoplay ? 'true' : 'false');
              metingEl.setAttribute('theme', config.player?.theme || '#b7daff');
              metingEl.setAttribute('loop', config.player?.loop || 'all');
              metingEl.setAttribute('order', config.player?.order || 'list');
              metingEl.setAttribute('preload', config.player?.preload || 'auto');
              metingEl.setAttribute('volume', String(config.player?.volume ?? 0.7));
              metingEl.setAttribute('mutex', config.player?.mutex !== false ? 'true' : 'false');
              metingEl.setAttribute('lrc-type', String(config.player?.lrcType ?? 3));
              metingEl.setAttribute('list-folded', config.player?.listFolded ? 'true' : 'false');
              metingEl.setAttribute('list-max-height', config.player?.listMaxHeight || '340px');
              metingEl.setAttribute('storage-name', config.player?.storageName || 'aplayer-setting');
            } else if (config.mode === "local" && processedLocalPlaylist && processedLocalPlaylist.length > 0) {
              if (processedLocalPlaylist.length === 1) {
                const song = processedLocalPlaylist[0];
                metingEl = document.createElement('meting-js');
                metingEl.setAttribute('name', song?.name || '');
                metingEl.setAttribute('artist', song?.artist || '');
                metingEl.setAttribute('url', song?.url || '');
                if (song?.cover) metingEl.setAttribute('cover', song.cover);
                metingEl.setAttribute('fixed', (config.player?.fixed ?? true) ? 'true' : 'false');
                metingEl.setAttribute('mini', (config.player?.mini ?? true) ? 'true' : 'false');
                metingEl.setAttribute('autoplay', config.player?.autoplay ? 'true' : 'false');
                metingEl.setAttribute('theme', config.player?.theme || '#b7daff');
                metingEl.setAttribute('loop', config.player?.loop || 'all');
                metingEl.setAttribute('order', config.player?.order || 'list');
                metingEl.setAttribute('preload', config.player?.preload || 'auto');
                metingEl.setAttribute('volume', String(config.player?.volume ?? 0.7));
                metingEl.setAttribute('mutex', config.player?.mutex !== false ? 'true' : 'false');
                metingEl.setAttribute('lrc-type', song?.lrc ? '2' : '0');
                metingEl.setAttribute('list-folded', config.player?.listFolded ? 'true' : 'false');
                metingEl.setAttribute('list-max-height', config.player?.listMaxHeight || '340px');
                metingEl.setAttribute('storage-name', config.player?.storageName || 'aplayer-setting');
                
                if (song?.lrc) {
                  const lrcElement = document.createElement('pre');
                  lrcElement.hidden = true;
                  lrcElement.textContent = song.lrc;
                  metingEl.appendChild(lrcElement);
                }
              }
            }

            if (metingEl) {
              aplayerContainer.appendChild(metingEl);
            }

            // ç­‰å¾…æ¸²æŸ“å®Œæˆ
            let handled = false;
            function tryResolve(){
              if (handled) return;
              if (metingEl && metingEl.aplayer) {
                aplayer = metingEl.aplayer;
                handled = true;
                bindAPlayerEvents(aplayer);
                resolve(aplayer);
              }
            }
            
            if (metingEl) {
              metingEl.addEventListener('rendered', tryResolve);
            }
            
            const poll = setInterval(()=>{ 
              tryResolve(); 
              if(handled) clearInterval(poll); 
            }, 300);
            
            setTimeout(()=>{ 
              if(!handled){ 
                clearInterval(poll); 
                reject(new Error('APlayer åˆå§‹åŒ–è¶…æ—¶')); 
              }
            }, 9000);
          });
        }

        // ç»‘å®š APlayer äº‹ä»¶
        function bindAPlayerEvents(ap){
          if (!ap) return;
          
          function updateCover(){
            try {
              const info = ap.list.audios[ap.list.index];
              if (info && info.cover && capsuleCover) {
                capsuleCover.src = info.cover;
              }
            } catch(e){
              console.log('æ›´æ–°å°é¢å¤±è´¥:', e);
            }
          }
          
          ap.on('loadeddata', updateCover);
          ap.on('listswitch', updateCover);
          ap.on('play', ()=> {
            if (capsule) capsule.classList.add('playing');
            startLyricsUpdate(ap);
          });
          ap.on('pause', ()=> {
            if (capsule) capsule.classList.remove('playing');
            if (floatingLyrics) floatingLyrics.classList.remove('show');
            currentLyric = '';
          });
          ap.on('ended', ()=> {
            if (floatingLyrics) floatingLyrics.classList.remove('show');
            currentLyric = '';
          });
        }

        // æ­Œè¯æ›´æ–°åŠŸèƒ½
        function startLyricsUpdate(ap) {
          if (lyricsInterval) {
            clearInterval(lyricsInterval);
          }
          
          lyricsInterval = setInterval(() => {
            updateLyricsFromDOM();
          }, 100);
        }

        function updateLyricsFromDOM() {
          try {
            if (!lyricsVisible) return;
            
            const lrcContainer = document.querySelector('.aplayer-lrc');
            if (!lrcContainer) {
              if (floatingLyrics) floatingLyrics.classList.remove('show');
              return;
            }
            
            const currentLrc = lrcContainer.querySelector('p.aplayer-lrc-current');
            const allLrcLines = lrcContainer.querySelectorAll('p');
            
            if (currentLrc && currentLrc.textContent.trim()) {
              const currentText = currentLrc.textContent.trim();
              let nextText = '';
              
              for (let i = 0; i < allLrcLines.length; i++) {
                if (allLrcLines[i] === currentLrc && i < allLrcLines.length - 1) {
                  nextText = allLrcLines[i + 1].textContent.trim();
                  break;
                }
              }
              
              showLyricsWithEffect(currentText, nextText);
            } else {
              if (floatingLyrics) floatingLyrics.classList.remove('show');
              currentLyric = '';
            }
          } catch (error) {
            if (floatingLyrics) floatingLyrics.classList.remove('show');
            currentLyric = '';
          }
        }

        function showLyricsWithEffect(currentText, nextText) {
          if (!lyricsVisible || !currentLineEl || !nextLineEl) return;
          if (currentText === currentLyric) return;
          
          currentLyric = currentText;
          currentLineEl.textContent = currentText;
          nextLineEl.textContent = nextText || '';
          
          if (currentText && currentText.trim() && floatingLyrics) {
            floatingLyrics.classList.add('show');
          } else if (floatingLyrics) {
            floatingLyrics.classList.remove('show');
          }
        }

        // å³é”®èœå•åŠŸèƒ½ - åœ¨æ•´ä¸ªé¡µé¢éƒ½å¯ä»¥è§¦å‘
        function showRightMenuAt(clientX, clientY){
          if (!rightMenu) return;
          
          rightMenu.style.display = 'block';
          rightMenu.classList.remove('show');
          requestAnimationFrame(()=>{
            const mw = rightMenu.offsetWidth || 220;
            const mh = rightMenu.offsetHeight || 280;
            let left = Math.round(clientX - mw/2);
            left = Math.max(8, Math.min(left, window.innerWidth - mw - 8));
            let top = clientY - mh - 12;
            if (top < 8) top = clientY + 12;
            if (top + mh > window.innerHeight - 8) top = Math.max(8, window.innerHeight - mh - 8);
            rightMenu.style.left = left + 'px';
            rightMenu.style.top = top + 'px';
            const arrowLeft = Math.max(12, Math.min(clientX - left, mw - 12));
            rightMenu.style.setProperty('--arrow-left', arrowLeft + 'px');
            rightMenu.classList.add('show');
          });
        }

        function hideRightMenuImmediate(){
          if (!rightMenu) return;
          rightMenu.classList.remove('show');
          rightMenu.style.display = 'none';
        }

        // æ­Œè¯æ˜¾ç¤º/éšè—æ§åˆ¶
        function toggleLyricsVisibility() {
          lyricsVisible = !lyricsVisible;
          
          if (lyricsVisible) {
            if (floatingLyrics) floatingLyrics.classList.add('show');
            if (aplayer && !aplayer.audio.paused) {
              startLyricsUpdate(aplayer);
            }
          } else {
            if (floatingLyrics) {
              floatingLyrics.classList.remove('show');
              currentLineEl.textContent = '';
              nextLineEl.textContent = '';
            }
            currentLyric = '';
          }
          
          const lyricsMenuItem = document.getElementById('menu-lyrics');
          if (lyricsMenuItem) {
            lyricsMenuItem.textContent = lyricsVisible ? 'ğŸ“œ éšè—æ­Œè¯' : 'ğŸ“œ æ˜¾ç¤ºæ­Œè¯';
          }
          localStorage.setItem('lyricsVisible', lyricsVisible.toString());
        }

        // æ’­æ”¾æ§åˆ¶å‡½æ•°
        function togglePlay() {
          if (aplayer) {
            aplayer.toggle();
          }
        }

        function prevSong() {
          if (aplayer) aplayer.skipBack();
        }

        function nextSong() {
          if (aplayer) aplayer.skipForward();
        }

        function volumeUp() {
          if (aplayer) {
            const newVolume = Math.min((aplayer.audio.volume || 0.7) + 0.1, 1);
            aplayer.volume(newVolume, true);
          }
        }

        function volumeDown() {
          if (aplayer) {
            const newVolume = Math.max((aplayer.audio.volume || 0.7) - 0.1, 0);
            aplayer.volume(newVolume, true);
          }
        }

        // è¾…åŠ©å‡½æ•°
        async function ensurePlayerAndRun(fn){
          try {
            const ap = await initMeting();
            if (typeof fn === 'function') fn(ap);
          } catch(err){
            console.warn('æ’­æ”¾å™¨æœªå°±ç»ªï¼š', err);
          }
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
          // åˆå§‹åŒ–æ­Œè¯æ˜¾ç¤ºçŠ¶æ€
          const savedLyricsVisible = localStorage.getItem('lyricsVisible');
          if (savedLyricsVisible !== null) {
            lyricsVisible = savedLyricsVisible === 'true';
          }
          
          const lyricsMenuItem = document.getElementById('menu-lyrics');
          if (lyricsMenuItem) {
            lyricsMenuItem.textContent = lyricsVisible ? 'ğŸ“œ éšè—æ­Œè¯' : 'ğŸ“œ æ˜¾ç¤ºæ­Œè¯';
          }
          
          if (!lyricsVisible && floatingLyrics) {
            floatingLyrics.classList.remove('show');
          }
          
          // èƒ¶å›Šç‚¹å‡»äº‹ä»¶
          if (capsule) {
            capsule.addEventListener('click', ()=>{
              if (playerWrap) {
                playerWrap.classList.add('show');
                initMeting().catch(()=>{});
              }
            });
          }
          
          // å³é”®èœå•äº‹ä»¶ - åœ¨æ•´ä¸ªé¡µé¢éƒ½å¯ä»¥è§¦å‘
          document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showRightMenuAt(e.clientX, e.clientY);
          });
          
          document.addEventListener('click', (e) => {
            if (rightMenu && !rightMenu.contains(e.target)) {
              hideRightMenuImmediate();
            }
          });
          
          // èœå•åŠŸèƒ½ç»‘å®š
          const menuPlay = document.getElementById('menu-play');
          const menuPrev = document.getElementById('menu-prev');
          const menuNext = document.getElementById('menu-next');
          const menuVolup = document.getElementById('menu-volup');
          const menuVoldown = document.getElementById('menu-voldown');
          const menuLyrics = document.getElementById('menu-lyrics');
          const menuSupport = document.getElementById('menu-support');
          const menuFullscreen = document.getElementById('menu-fullscreen');
          const menuClose = document.getElementById('menu-close');

          if (menuPlay) menuPlay.addEventListener('click', ()=>{ ensurePlayerAndRun(ap=>ap.toggle()); hideRightMenuImmediate(); });
          if (menuPrev) menuPrev.addEventListener('click', ()=>{ ensurePlayerAndRun(ap=>ap.skipBack()); hideRightMenuImmediate(); });
          if (menuNext) menuNext.addEventListener('click', ()=>{ ensurePlayerAndRun(ap=>ap.skipForward()); hideRightMenuImmediate(); });
          if (menuVolup) menuVolup.addEventListener('click', ()=>{ volumeUp(); hideRightMenuImmediate(); });
          if (menuVoldown) menuVoldown.addEventListener('click', ()=>{ volumeDown(); hideRightMenuImmediate(); });
          if (menuLyrics) menuLyrics.addEventListener('click', ()=>{ toggleLyricsVisibility(); hideRightMenuImmediate(); });
          if (menuSupport) menuSupport.addEventListener('click', ()=>{ window.open('https://1356666.xyz','_blank'); hideRightMenuImmediate(); });
          if (menuFullscreen) menuFullscreen.addEventListener('click', ()=>{ 
            if (!document.fullscreenElement) {
              document.documentElement.requestFullscreen().catch(()=>{});
            } else {
              document.exitFullscreen().catch(()=>{});
            }
            hideRightMenuImmediate();
          });
          if (menuClose) menuClose.addEventListener('click', ()=>{ 
            ensurePlayerAndRun(ap=>ap.pause()); 
            if (playerWrap) playerWrap.classList.remove('show');
            hideRightMenuImmediate(); 
          });

          // é¢„åˆå§‹åŒ–
          initMeting().then(ap=>{
            console.log('APlayeråˆå§‹åŒ–å®Œæˆ');
          }).catch(()=>{
            console.log('APlayeråˆå§‹åŒ–å¤±è´¥');
          });
        });

        // åŠ è½½å¿…è¦çš„è„šæœ¬
        function loadScripts() {
          return new Promise((resolve) => {
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
            if (window.APlayer && window.customElements?.get("meting-js")) {
              resolve();
              return;
            }

            let scriptsLoaded = 0;
            const totalScripts = 2;

            function checkAllLoaded() {
              scriptsLoaded++;
              if (scriptsLoaded === totalScripts) {
                resolve();
              }
            }

            // åŠ è½½ APlayer
            if (!window.APlayer) {
              const aplayerScript = document.createElement("script");
              aplayerScript.src = '{aplayerJsPath}';
              aplayerScript.async = true;
              aplayerScript.onload = checkAllLoaded;
              aplayerScript.onerror = checkAllLoaded;
              document.head.appendChild(aplayerScript);
            } else {
              checkAllLoaded();
            }

            // åŠ è½½ MetingJS
            if (!window.customElements?.get("meting-js")) {
              const metingScript = document.createElement("script");
              metingScript.src = '{metingJsPath}';
              metingScript.async = true;
              metingScript.onload = checkAllLoaded;
              metingScript.onerror = checkAllLoaded;
              document.head.appendChild(metingScript);
            } else {
              checkAllLoaded();
            }
          });
        }

        // å¯åŠ¨
        loadScripts().then(() => {
          console.log('éŸ³ä¹æ’­æ”¾å™¨è„šæœ¬åŠ è½½å®Œæˆ');
        });
      })();
    </script>
  </>
)}

<style is:global>
  /* ===== æ’­æ”¾å™¨é¢æ¿ï¼ˆç‚¹å‡»èƒ¶å›Šå±•å¼€ï¼‰ ===== */
  #player-wrap {
    position: fixed;
    left: 18px;
    bottom: 92px;
    width: 360px;
    max-width: calc(100% - 36px);
    z-index: 15000;
    display: none;
    transform-origin: left bottom;
  }
  #player-wrap.show {
    display: block;
    animation: popIn .18s ease;
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(.96) }
    to { opacity: 1; transform: scale(1) }
  }

  /* APlayer å¾®è°ƒæ ·å¼ */
  .aplayer { 
    border-radius: 12px !important; 
    overflow: hidden !important; 
  }

  /* ===== éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ä¿®æ”¹ ===== */
  /* é¡¶éƒ¨æ­Œæ›²åæ”¹ä¸ºé»‘è‰² */
  .aplayer .aplayer-info .aplayer-music .aplayer-title {
    color: #000 !important;
    font-weight: bold;
  }

  /* æ’­æ”¾åˆ—è¡¨æ­Œåæ”¹ä¸ºé»‘è‰² */
  .aplayer .aplayer-list ol li {
    color: #000 !important;
  }

  .aplayer .aplayer-list ol li .aplayer-list-title {
    color: #000 !important;
  }

  /* æ­Œè¯æ”¹ä¸ºæ©™è‰² */
  .aplayer .aplayer-lrc p {
    color: #ff8c00 !important;
  }

  .aplayer .aplayer-lrc p.aplayer-lrc-current {
    color: #ff4500 !important;
    font-weight: bold;
    font-size: 16px;
  }

  /* æ’­æ”¾å™¨æ•´ä½“æ ·å¼è°ƒæ•´ */
  .aplayer {
    background: rgba(255, 255, 255, 0.9) !important;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  /* ===== ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º ===== */
  .floating-lyrics {
    position: fixed;
    left: 100px;
    bottom: 50px;
    text-align: left;
    z-index: 99999;
    color: #ff8c00;
    font-size: 18px;
    font-weight: bold;
    text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9);
    background: rgba(255, 255, 255, 0.10);
    padding: 15px 20px;
    border-radius: 12px;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    max-width: 400px;
    opacity: 0;
    transition: opacity 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    pointer-events: none;
    display: none;
  }

  .floating-lyrics.show {
    opacity: 1;
    display: block;
  }

  .floating-lyrics .current-line {
    color: #ff4500;
    font-size: 30px;
    margin-bottom: 8px;
    font-weight: bold;
    min-height: 24px;
  }

  .floating-lyrics .next-line {
    color: #ff8c00;
    font-size: 14px;
    opacity: 0.8;
    min-height: 18px;
  }

  /* ===== éŸ³ä¹èƒ¶å›Šï¼ˆå›ºå®šå·¦ä¸‹ï¼‰ ===== */
  .music-capsule {
    position: fixed;
    left: 22px;
    bottom: 96px;
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 30000;
    background: radial-gradient(circle at 30% 30%, #00c3ff, #0061ff);
    box-shadow: 0 8px 28px rgba(0, 180, 255, 0.12);
    transition: transform 0.3s ease;
  }

  .music-capsule:hover {
    transform: scale(1.05);
  }

  .music-capsule img {
    width: 64%;
    height: 64%;
    border-radius: 50%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .music-capsule.playing {
    background: radial-gradient(circle at 30% 30%, #ff9500, #ff5e00);
    box-shadow: 0 8px 28px rgba(255, 140, 0, 0.28);
  }

  .music-capsule.playing img {
    animation: spin 6s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0) }
    to { transform: rotate(360deg) }
  }

  /* é»‘èƒ¶å”±ç‰‡æ»‘åŠ¨æ† */
  .vinyl-arm {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    width: 90px;
    height: 70px;
    z-index: 10;
    pointer-events: none;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .arm-base {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 16px;
    height: 25px;
    background: linear-gradient(135deg, #8b8b8b, #4a4a4a, #8b8b8b);
    border-radius: 4px 4px 2px 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    border: 1px solid #5a5a5a;
  }

  .arm-rod {
    position: absolute;
    top: 25px;
    left: 50%;
    width: 3px;
    height: 45px;
    background: linear-gradient(to bottom, #c0c0c0, #808080, #505050);
    transform-origin: top center;
    transform: translateX(-50%) rotate(-25deg);
    transition: transform 0.8s cubic-bezier(0.34, 1.2, 0.64, 1);
    border-radius: 1px;
  }

  .arm-head {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 12px;
    height: 12px;
    background: linear-gradient(135deg, #333, #000);
    border-radius: 50%;
    transform: translateX(-50%);
    box-shadow: 0 1px 6px rgba(0,0,0,0.6), 
          inset 0 1px 1px rgba(255,255,255,0.2);
    border: 1px solid #000;
  }

  /* æ’­æ”¾çŠ¶æ€ */
  .music-capsule.playing .vinyl-arm .arm-rod {
    transform: translateX(-50%) rotate(25deg);
  }

  /* ===== å³é”®èœå•ï¼ˆæ¯›ç»ç’ƒåŠé€æ˜ï¼‰ ===== */
  #right-menu {
    position: fixed;
    display: none;
    z-index: 40000;
    min-width: 220px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #008000;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    padding: 6px 0;
    opacity: 0;
    transform: scale(.98);
    transition: opacity .12s,transform .12s;
  }
  #right-menu.show {
    display: flex;
    opacity: 1;
    transform: scale(1);
    flex-direction: column;
  }
  #right-menu li {
    list-style: none;
    padding: 10px 16px;
    cursor: pointer;
    white-space: nowrap;
    font-weight: 700;
    transition: background .12s;
  }
  #right-menu li:hover {
    background: rgba(255,255,255,0.14);
    color: #f97316;
    border-radius: 6px;
  }
  #right-menu::after {
    content: "";
    position: absolute;
    top: -8px;
    left: var(--arrow-left,24px);
    transform: translateX(-50%);
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid rgba(255,255,255,0.12);
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .music-capsule {
      left: 18px;
      bottom: 22px;
      width: 60px;
      height: 60px;
    }
    
    .floating-lyrics {
      left: 90px;
      bottom: 30px;
      max-width: 250px;
      font-size: 16px;
    }
    
    .floating-lyrics .current-line {
      font-size: 18px;
    }
    
    .floating-lyrics .next-line {
      font-size: 12px;
    }
    
    #player-wrap {
      width: calc(100vw - 36px);
      max-width: 360px;
    }
  }

  /* ç§»åŠ¨ç«¯éšè— */
  .mobile-hide {
    display: none !important;
  }
</style>
