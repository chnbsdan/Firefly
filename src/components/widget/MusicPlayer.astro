---
// src/components/widget/MusicPlayer.astro
import type { MusicPlayerConfig } from "../../types/config";
import { musicPlayerConfig } from "../../config/musicConfig";
import { url } from "../../utils/url-utils";

const config = musicPlayerConfig;

// é¢„å…ˆç”Ÿæˆæœ¬åœ°èµ„æºè·¯å¾„ï¼Œç¡®ä¿åœ¨éæ ¹ç›®å½•éƒ¨ç½²æ—¶ä¹Ÿèƒ½æ­£ç¡®åŠ è½½
const aplayerCssPath = url("/assets/css/APlayer.min.css");
const aplayerCustomCssPath = url("/assets/css/APlayer.custom.css");
const aplayerJsPath = url("/assets/js/APlayer.min.js");

// MetingJS è·¯å¾„å¤„ç†
const metingJsPath = config.meting?.jsPath
  ? (config.meting.jsPath.startsWith("http://") || config.meting.jsPath.startsWith("https://"))
    ? config.meting.jsPath
    : url(config.meting.jsPath)
  : "https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js";

// é¢„å¤„ç†æœ¬åœ°éŸ³ä¹åˆ—è¡¨çš„è·¯å¾„
const processedLocalPlaylist = config.mode === "local" && config.local?.playlist
  ? config.local.playlist.map((song) => ({
      ...song,
      url: url(song.url),
      cover: song.cover ? url(song.cover) : undefined,
    }))
  : null;
---

{config.enable && (
  <>
    <!-- APlayer CSS -->
    <link rel="stylesheet" href={aplayerCssPath} />
    <link rel="stylesheet" href={aplayerCustomCssPath} />

    <!-- éŸ³ä¹èƒ¶å›Š -->
    <div id="music-capsule" class="music-capsule" title="ç‚¹å‡»å±•å¼€æ’­æ”¾å™¨">
      <img id="capsule-cover" src="https://p2.music.126.net/4HGEnXVexEfF2M4WdDdfrQ==/109951166354363385.jpg" alt="ä¸“è¾‘å°é¢" />
      <!-- é»‘èƒ¶å”±ç‰‡æ»‘åŠ¨æ† -->
      <div class="vinyl-arm">
        <div class="arm-base"></div>
        <div class="arm-rod"></div>
        <div class="arm-head"></div>
      </div>
    </div>

    <!-- ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º -->
    <div id="floating-lyrics" class="floating-lyrics">
      <div class="current-line"></div>
      <div class="next-line"></div>
    </div>

    <!-- æ’­æ”¾å™¨å®¹å™¨ -->
    <div id="player-wrap" aria-hidden="true">
      <div id="aplayer-container" class:mobile-hide={config.responsive?.mobile?.hide}></div>
    </div>

    <!-- å³é”®èœå• -->
    <ul id="right-menu" role="menu" aria-hidden="true">
      <li id="menu-play">â–¶ æ’­æ”¾ / æš‚åœ</li>
      <li id="menu-prev">â® ä¸Šä¸€é¦–</li>
      <li id="menu-next">â­ ä¸‹ä¸€é¦–</li>
      <li id="menu-volup">ğŸ”Š éŸ³é‡ +</li>
      <li id="menu-voldown">ğŸ”‰ éŸ³é‡ -</li>
      <li id="menu-lyrics">ğŸ“œ æ˜¾ç¤º/éšè—æ­Œè¯</li>
      <li id="menu-support">ğŸ’¡ æŠ€æœ¯æ”¯æŒ</li>
      <li id="menu-fullscreen">ğŸ–¥ï¸ å…¨å±æ¨¡å¼</li>
      <li id="menu-close">âŒ å…³é—­æ’­æ”¾å™¨</li>
    </ul>

    <!-- éŸ³ä¹æ’­æ”¾å™¨è„šæœ¬ -->
    <script>
      // éŸ³ä¹æ’­æ”¾å™¨é…ç½®
      const MUSIC_CONFIG = {
        enable: ${config.enable},
        mode: "${config.mode}",
        meting: ${JSON.stringify(config.meting || {})},
        player: ${JSON.stringify(config.player || {})},
        local: ${JSON.stringify(processedLocalPlaylist || [])},
        responsive: ${JSON.stringify(config.responsive || {})}
      };

      // è„šæœ¬è·¯å¾„
      const APLAYER_JS_PATH = "${aplayerJsPath}";
      const METING_JS_PATH = "${metingJsPath}";
    </script>
    <script src="/assets/js/music-player.js" defer></script>
  </>
)}

<style>
  /* ===== æ’­æ”¾å™¨é¢æ¿ï¼ˆç‚¹å‡»èƒ¶å›Šå±•å¼€ï¼‰ ===== */
  #player-wrap {
    position: fixed;
    left: 18px;
    bottom: 92px;
    width: 360px;
    max-width: calc(100% - 36px);
    z-index: 15000;
    display: none;
    transform-origin: left bottom;
  }
  #player-wrap.show {
    display: block;
    animation: popIn .18s ease;
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(.96) }
    to { opacity: 1; transform: scale(1) }
  }

  /* APlayer å¾®è°ƒæ ·å¼ */
  .aplayer { 
    border-radius: 12px !important; 
    overflow: hidden !important; 
  }

  /* ===== éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ä¿®æ”¹ ===== */
  /* é¡¶éƒ¨æ­Œæ›²åæ”¹ä¸ºé»‘è‰² */
  .aplayer .aplayer-info .aplayer-music .aplayer-title {
    color: #000 !important;
    font-weight: bold;
  }

  /* æ’­æ”¾åˆ—è¡¨æ­Œåæ”¹ä¸ºé»‘è‰² */
  .aplayer .aplayer-list ol li {
    color: #000 !important;
  }

  .aplayer .aplayer-list ol li .aplayer-list-title {
    color: #000 !important;
  }

  /* æ­Œè¯æ”¹ä¸ºæ©™è‰² */
  .aplayer .aplayer-lrc p {
    color: #ff8c00 !important;
  }

  .aplayer .aplayer-lrc p.aplayer-lrc-current {
    color: #ff4500 !important;
    font-weight: bold;
    font-size: 16px;
  }

  /* æ’­æ”¾å™¨æ•´ä½“æ ·å¼è°ƒæ•´ */
  .aplayer {
    background: rgba(255, 255, 255, 0.9) !important;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  /* ===== ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º ===== */
  .floating-lyrics {
    position: fixed;
    left: 100px;
    bottom: 50px;
    text-align: left;
    z-index: 99999;
    color: #ff8c00;
    font-size: 18px;
    font-weight: bold;
    text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9);
    background: rgba(255, 255, 255, 0.10);
    padding: 15px 20px;
    border-radius: 12px;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    max-width: 400px;
    opacity: 0;
    transition: opacity 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    pointer-events: none;
    display: none;
  }

  .floating-lyrics.show {
    opacity: 1;
    display: block;
  }

  .floating-lyrics .current-line {
    color: #ff4500;
    font-size: 30px;
    margin-bottom: 8px;
    font-weight: bold;
    min-height: 24px;
  }

  .floating-lyrics .next-line {
    color: #ff8c00;
    font-size: 14px;
    opacity: 0.8;
    min-height: 18px;
  }

  /* ===== éŸ³ä¹èƒ¶å›Šï¼ˆå›ºå®šå·¦ä¸‹ï¼‰ ===== */
  .music-capsule {
    position: fixed;
    left: 22px;
    bottom: 96px;
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 30000;
    background: radial-gradient(circle at 30% 30%, #00c3ff, #0061ff);
    box-shadow: 0 8px 28px rgba(0, 180, 255, 0.12);
    transition: transform 0.3s ease;
  }

  .music-capsule:hover {
    transform: scale(1.05);
  }

  .music-capsule img {
    width: 64%;
    height: 64%;
    border-radius: 50%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .music-capsule.playing {
    background: radial-gradient(circle at 30% 30%, #ff9500, #ff5e00);
    box-shadow: 0 8px 28px rgba(255, 140, 0, 0.28);
  }

  .music-capsule.playing img {
    animation: spin 6s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0) }
    to { transform: rotate(360deg) }
  }

  /* é»‘èƒ¶å”±ç‰‡æ»‘åŠ¨æ† */
  .vinyl-arm {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    width: 90px;
    height: 70px;
    z-index: 10;
    pointer-events: none;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .arm-base {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 16px;
    height: 25px;
    background: linear-gradient(135deg, #8b8b8b, #4a4a4a, #8b8b8b);
    border-radius: 4px 4px 2px 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    border: 1px solid #5a5a5a;
  }

  .arm-rod {
    position: absolute;
    top: 25px;
    left: 50%;
    width: 3px;
    height: 45px;
    background: linear-gradient(to bottom, #c0c0c0, #808080, #505050);
    transform-origin: top center;
    transform: translateX(-50%) rotate(-25deg);
    transition: transform 0.8s cubic-bezier(0.34, 1.2, 0.64, 1);
    border-radius: 1px;
  }

  .arm-head {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 12px;
    height: 12px;
    background: linear-gradient(135deg, #333, #000);
    border-radius: 50%;
    transform: translateX(-50%);
    box-shadow: 0 1px 6px rgba(0,0,0,0.6), 
          inset 0 1px 1px rgba(255,255,255,0.2);
    border: 1px solid #000;
  }

  /* æ’­æ”¾çŠ¶æ€ */
  .music-capsule.playing .vinyl-arm .arm-rod {
    transform: translateX(-50%) rotate(25deg);
  }

  /* ===== å³é”®èœå•ï¼ˆæ¯›ç»ç’ƒåŠé€æ˜ï¼‰ ===== */
  #right-menu {
    position: fixed;
    display: none;
    z-index: 40000;
    min-width: 220px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #008000;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    padding: 6px 0;
    opacity: 0;
    transform: scale(.98);
    transition: opacity .12s,transform .12s;
  }
  #right-menu.show {
    display: flex;
    opacity: 1;
    transform: scale(1);
    flex-direction: column;
  }
  #right-menu li {
    list-style: none;
    padding: 10px 16px;
    cursor: pointer;
    white-space: nowrap;
    font-weight: 700;
    transition: background .12s;
  }
  #right-menu li:hover {
    background: rgba(255,255,255,0.14);
    color: #f97316;
    border-radius: 6px;
  }
  #right-menu::after {
    content: "";
    position: absolute;
    top: -8px;
    left: var(--arrow-left,24px);
    transform: translateX(-50%);
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid rgba(255,255,255,0.12);
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .music-capsule {
      left: 18px;
      bottom: 22px;
      width: 60px;
      height: 60px;
    }
    
    .floating-lyrics {
      left: 90px;
      bottom: 30px;
      max-width: 250px;
      font-size: 16px;
    }
    
    .floating-lyrics .current-line {
      font-size: 18px;
    }
    
    .floating-lyrics .next-line {
      font-size: 12px;
    }
    
    #player-wrap {
      width: calc(100vw - 36px);
      max-width: 360px;
    }
  }

  /* ç§»åŠ¨ç«¯éšè— */
  .mobile-hide {
    display: none !important;
  }
</style>
