---
import { musicPlayerConfig } from "@/config/musicConfig";
import { url } from "@/utils/url-utils";

const config = musicPlayerConfig;

// é¢„å…ˆç”Ÿæˆæœ¬åœ°èµ„æºè·¯å¾„ï¼Œç¡®ä¿åœ¨éæ ¹ç›®å½•éƒ¨ç½²æ—¶ä¹Ÿèƒ½æ­£ç¡®åŠ è½½
const aplayerCssPath = url("/assets/css/APlayer.min.css");
const aplayerCustomCssPath = url("/assets/css/APlayer.custom.css");
const aplayerJsPath = url("/assets/js/APlayer.min.js");

// MetingJS è·¯å¾„å¤„ç†
const metingJsPath = config.meting?.jsPath
  ? (config.meting.jsPath.startsWith("http://") || config.meting.jsPath.startsWith("https://"))
    ? config.meting.jsPath
    : url(config.meting.jsPath)
  : "https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js";

// é¢„å¤„ç†æœ¬åœ°éŸ³ä¹åˆ—è¡¨çš„è·¯å¾„
const processedLocalPlaylist = config.mode === "local" && config.local?.playlist
  ? config.local.playlist.map((song) => ({
      ...song,
      url: url(song.url),
      cover: song.cover ? url(song.cover) : undefined,
    }))
  : null;
---

{config.enable && (
  <>
    <!-- APlayer CSS -->
    <link rel="stylesheet" href={aplayerCssPath} />
    <link rel="stylesheet" href={aplayerCustomCssPath} />

    <!-- éŸ³ä¹èƒ¶å›Š -->
    <div id="music-capsule" class="music-capsule" title="ç‚¹å‡»å±•å¼€æ’­æ”¾å™¨">
      <img id="capsule-cover" src="https://p2.music.126.net/4HGEnXVexEfF2M4WdDdfrQ==/109951166354363385.jpg" alt="ä¸“è¾‘å°é¢" />
    </div>

    <!-- ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º -->
    <div id="floating-lyrics" class="floating-lyrics">
      <div class="current-line"></div>
      <div class="next-line"></div>
    </div>

    <!-- å³é”®èœå• -->
    <ul id="right-menu" role="menu" aria-hidden="true">
      <li id="menu-play">â–¶ æ’­æ”¾ / æš‚åœ</li>
      <li id="menu-prev">â® ä¸Šä¸€é¦–</li>
      <li id="menu-next">â­ ä¸‹ä¸€é¦–</li>
      <li id="menu-volup">ğŸ”Š éŸ³é‡ +</li>
      <li id="menu-voldown">ğŸ”‰ éŸ³é‡ -</li>
      <li id="menu-lyrics">ğŸ“œ æ˜¾ç¤º/éšè—æ­Œè¯</li>
      <li id="menu-support">ğŸ’¡ æŠ€æœ¯æ”¯æŒ</li>
      <li id="menu-fullscreen">ğŸ–¥ï¸ å…¨å±æ¨¡å¼</li>
      <li id="menu-close">âŒ å…³é—­æ’­æ”¾å™¨</li>
    </ul>

    <!-- éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ -->
    <div id="aplayer-container" class:mobile-hide={config.responsive?.mobile?.hide}>
      {config.mode === "meting" && config.meting ? (
        <meting-js
          server={config.meting.server || "netease"}
          type={config.meting.type || "playlist"}
          id={config.meting.id || ""}
          api={config.meting.api}
          auth={config.meting.auth}
          fixed={(config.player?.fixed ?? true) ? "true" : "false"}
          mini={(config.player?.mini ?? true) ? "true" : "false"}
          autoplay={config.player?.autoplay ? "true" : "false"}
          theme={config.player?.theme || "#b7daff"}
          loop={config.player?.loop || "all"}
          order={config.player?.order || "list"}
          preload={config.player?.preload || "auto"}
          volume={String(config.player?.volume ?? 0.7)}
          mutex={config.player?.mutex !== false ? "true" : "false"}
          lrc-type={String(config.player?.lrcType ?? 3)}
          list-folded={config.player?.listFolded ? "true" : "false"}
          list-max-height={config.player?.listMaxHeight || "340px"}
          storage-name={config.player?.storageName || "aplayer-setting"}
        />
      ) : config.mode === "local" && processedLocalPlaylist && processedLocalPlaylist.length > 0 ? (
        processedLocalPlaylist.length === 1 ? (
          <meting-js
            name={processedLocalPlaylist?.[0]?.name || ""}
            artist={processedLocalPlaylist?.[0]?.artist || ""}
            url={processedLocalPlaylist?.[0]?.url || ""}
            cover={processedLocalPlaylist?.[0]?.cover}
            fixed={(config.player?.fixed ?? true) ? "true" : "false"}
            mini={(config.player?.mini ?? true) ? "true" : "false"}
            autoplay={config.player?.autoplay ? "true" : "false"}
            theme={config.player?.theme || "#b7daff"}
            loop={config.player?.loop || "all"}
            order={config.player?.order || "list"}
            preload={config.player?.preload || "auto"}
            volume={String(config.player?.volume ?? 0.7)}
            mutex={config.player?.mutex !== false ? "true" : "false"}
            lrc-type={processedLocalPlaylist[0]?.lrc ? "2" : "0"}
            list-folded={config.player?.listFolded ? "true" : "false"}
            list-max-height={config.player?.listMaxHeight || "340px"}
            storage-name={config.player?.storageName || "aplayer-setting"}
          >
            {processedLocalPlaylist?.[0]?.lrc && (
              <pre hidden>{processedLocalPlaylist[0].lrc}</pre>
            )}
          </meting-js>
        ) : (
          <div id="local-aplayer"></div>
        )
      ) : null}
    </div>
  </>
)}

<script define:vars={{ config, aplayerJsPath, metingJsPath, processedLocalPlaylist }} is:inline>
  (function() {
    if (!config.enable) return;
    if (typeof window === 'undefined') return;

    // çŠ¶æ€å˜é‡
    let lyricsVisible = localStorage.getItem('lyricsVisible') !== 'false';
    let isPlayerVisible = false;
    let lyricsUpdateInterval = null;

    // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
    function initAllFeatures() {
      initCapsule();
      initRightClickMenu();
      initPlayerListener();
    }

    // åˆå§‹åŒ–èƒ¶å›Š
    function initCapsule() {
      const capsule = document.getElementById('music-capsule');
      if (!capsule) return;

      // èƒ¶å›Šç‚¹å‡» - åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º
      capsule.addEventListener('click', togglePlayerVisibility);

      // åˆå§‹éšè—æ’­æ”¾å™¨
      const container = document.getElementById('aplayer-container');
      if (container) {
        container.style.display = 'none';
      }
    }

    // åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º
    function togglePlayerVisibility() {
      const container = document.getElementById('aplayer-container');
      if (!container) return;
      
      isPlayerVisible = !isPlayerVisible;
      container.style.display = isPlayerVisible ? '' : 'none';
    }

    // åˆ‡æ¢æ­Œè¯æ˜¾ç¤º
    function toggleLyricsVisibility() {
      lyricsVisible = !lyricsVisible;
      localStorage.setItem('lyricsVisible', lyricsVisible.toString());
      updateLyricsDisplay();
      
      // å¦‚æœåˆ‡æ¢ä¸ºæ˜¾ç¤ºï¼Œå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡æ­Œè¯
      if (lyricsVisible) {
        const aplayer = getAPlayerInstance();
        if (aplayer && aplayer.lrc) {
          forceUpdateLyrics(aplayer);
        }
      }
    }

    // å¼ºåˆ¶æ›´æ–°æ­Œè¯æ˜¾ç¤º
    function forceUpdateLyrics(aplayer) {
      if (!aplayer.lrc || !lyricsVisible) return;
      
      try {
        const currentTime = aplayer.audio.currentTime;
        const lrcData = aplayer.lrc;
        
        if (lrcData && lrcData.lrc) {
          // æŸ¥æ‰¾å½“å‰æ—¶é—´å¯¹åº”çš„æ­Œè¯
          let currentText = '';
          let nextText = '';
          let prevTime = 0;
          
          // éå†æ­Œè¯æ•°æ®æ‰¾åˆ°å½“å‰å’Œä¸‹ä¸€å¥
          const times = Object.keys(lrcData.lrc).map(Number).sort((a, b) => a - b);
          for (let i = 0; i < times.length; i++) {
            if (currentTime >= times[i]) {
              currentText = lrcData.lrc[times[i]] || '';
              if (i < times.length - 1) {
                nextText = lrcData.lrc[times[i + 1]] || '';
              }
            }
          }
          
          updateLyrics(currentText, nextText);
        }
      } catch (error) {
        console.log('å¼ºåˆ¶æ›´æ–°æ­Œè¯å¤±è´¥:', error);
      }
    }

    // æ›´æ–°æ­Œè¯æ˜¾ç¤º
    function updateLyricsDisplay() {
      const floatingLyrics = document.getElementById('floating-lyrics');
      if (floatingLyrics) {
        if (lyricsVisible) {
          floatingLyrics.style.display = 'block';
          // æ˜¾ç¤ºæ—¶å¼ºåˆ¶æ›´æ–°ä¸€æ¬¡æ­Œè¯
          const aplayer = getAPlayerInstance();
          if (aplayer) {
            setTimeout(() => forceUpdateLyrics(aplayer), 100);
          }
        } else {
          floatingLyrics.style.display = 'none';
          floatingLyrics.classList.remove('show');
        }
      }
    }

    // åˆå§‹åŒ–å³é”®èœå•
    function initRightClickMenu() {
      const rightMenu = document.getElementById('right-menu');
      if (!rightMenu) return;

      // æ˜¾ç¤ºèœå•
      function showMenuAt(clientX, clientY) {
        rightMenu.style.display = 'block';
        rightMenu.classList.remove('show');
        
        setTimeout(() => {
          const menuRect = rightMenu.getBoundingClientRect();
          const menuWidth = menuRect.width;
          const menuHeight = menuRect.height;
          
          let left = clientX;
          let top = clientY;
          
          // æ°´å¹³æ–¹å‘è°ƒæ•´
          if (left + menuWidth > window.innerWidth - 10) {
            left = clientX - menuWidth;
          }
          
          // å‚ç›´æ–¹å‘è°ƒæ•´
          if (top + menuHeight > window.innerHeight - 10) {
            top = clientY - menuHeight;
          }
          
          // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
          left = Math.max(10, Math.min(left, window.innerWidth - menuWidth - 10));
          top = Math.max(10, Math.min(top, window.innerHeight - menuHeight - 10));
          
          rightMenu.style.left = left + 'px';
          rightMenu.style.top = top + 'px';
          
          // ç®­å¤´ä½ç½®
          const arrowLeft = Math.max(15, Math.min(clientX - left, menuWidth - 15));
          rightMenu.style.setProperty('--arrow-left', arrowLeft + 'px');
          
          rightMenu.classList.add('show');
        }, 10);
      }

      // éšè—èœå•
      function hideRightMenuImmediate() {
        rightMenu.classList.remove('show');
        setTimeout(() => {
          rightMenu.style.display = 'none';
        }, 200);
      }

      // ç»‘å®šèœå•äº‹ä»¶
      document.getElementById('menu-play').addEventListener('click', () => { togglePlay(); hideRightMenuImmediate(); });
      document.getElementById('menu-prev').addEventListener('click', () => { prevSong(); hideRightMenuImmediate(); });
      document.getElementById('menu-next').addEventListener('click', () => { nextSong(); hideRightMenuImmediate(); });
      document.getElementById('menu-volup').addEventListener('click', () => { volumeUp(); hideRightMenuImmediate(); });
      document.getElementById('menu-voldown').addEventListener('click', () => { volumeDown(); hideRightMenuImmediate(); });
      document.getElementById('menu-lyrics').addEventListener('click', () => { toggleLyricsVisibility(); hideRightMenuImmediate(); });
      document.getElementById('menu-support').addEventListener('click', () => { window.open('https://1356666.xyz','_blank'); hideRightMenuImmediate(); });
      document.getElementById('menu-fullscreen').addEventListener('click', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(()=>{});
        } else {
          document.exitFullscreen().catch(()=>{});
        }
        hideRightMenuImmediate();
      });
      document.getElementById('menu-close').addEventListener('click', () => { 
        const aplayer = getAPlayerInstance();
        if (aplayer) aplayer.pause();
        togglePlayerVisibility();
        hideRightMenuImmediate();
      });

      // å…¨å±€å³é”®äº‹ä»¶
      document.addEventListener('contextmenu', function(e) {
        const target = e.target;
        const isOnCapsule = target.closest('#music-capsule');
        const isOnPlayer = target.closest('.aplayer') || target.closest('#aplayer-container');
        
        if (isOnCapsule || isOnPlayer) {
          e.preventDefault();
          e.stopPropagation();
          showMenuAt(e.clientX, e.clientY);
        }
      });

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
      document.addEventListener('click', function(e) {
        if (!rightMenu.contains(e.target)) {
          hideRightMenuImmediate();
        }
      });

      // ESCé”®éšè—èœå•
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hideRightMenuImmediate();
        }
      });

      // çª—å£å¤§å°å˜åŒ–æ—¶éšè—èœå•
      window.addEventListener('resize', hideRightMenuImmediate);
    }

    // æ’­æ”¾æ§åˆ¶å‡½æ•°
    function getAPlayerInstance() {
      const metingElement = document.querySelector('meting-js');
      if (metingElement?.aplayer) return metingElement.aplayer;
      const localPlayer = document.getElementById('local-aplayer');
      if (localPlayer?.aplayer) return localPlayer.aplayer;
      const aplayerElements = document.querySelectorAll('.aplayer');
      for (let element of aplayerElements) {
        if (element.aplayer) return element.aplayer;
      }
      return null;
    }

    function togglePlay() {
      const aplayer = getAPlayerInstance();
      if (aplayer) {
        aplayer.toggle();
      }
    }

    function prevSong() {
      const aplayer = getAPlayerInstance();
      if (aplayer) aplayer.skipBack();
    }

    function nextSong() {
      const aplayer = getAPlayerInstance();
      if (aplayer) aplayer.skipForward();
    }

    function volumeUp() {
      const aplayer = getAPlayerInstance();
      if (aplayer) {
        const newVolume = Math.min((aplayer.audio.volume || 0.7) + 0.1, 1);
        aplayer.volume(newVolume, true);
      }
    }

    function volumeDown() {
      const aplayer = getAPlayerInstance();
      if (aplayer) {
        const newVolume = Math.max((aplayer.audio.volume || 0.7) - 0.1, 0);
        aplayer.volume(newVolume, true);
      }
    }

    // åˆå§‹åŒ–æ’­æ”¾å™¨ç›‘å¬ - ä¿®å¤æ­Œè¯æ˜¾ç¤º
    function initPlayerListener() {
      const aplayer = getAPlayerInstance();
      if (!aplayer) {
        setTimeout(initPlayerListener, 500);
        return;
      }

      const capsule = document.getElementById('music-capsule');
      const capsuleCover = document.getElementById('capsule-cover');
      const floatingLyrics = document.getElementById('floating-lyrics');
      const currentLineEl = floatingLyrics?.querySelector('.current-line');
      const nextLineEl = floatingLyrics?.querySelector('.next-line');

      let currentLyric = '';

      // ç›‘å¬æ’­æ”¾çŠ¶æ€
      aplayer.on('play', function() {
        if (capsule) capsule.classList.add('playing');
        updateCover();
        // æ’­æ”¾æ—¶å¼ºåˆ¶æ›´æ–°æ­Œè¯
        if (lyricsVisible) {
          setTimeout(() => forceUpdateLyrics(aplayer), 100);
        }
      });
      
      aplayer.on('pause', function() {
        if (capsule) capsule.classList.remove('playing');
      });
      
      aplayer.on('ended', function() {
        if (capsule) capsule.classList.remove('playing');
        updateLyrics('', '');
      });
      
      aplayer.on('loadeddata', updateCover);
      aplayer.on('listswitch', updateCover);

      // ç›‘å¬æ­Œè¯ç›¸å…³äº‹ä»¶
      aplayer.on('lrcshow', function() {
        console.log('æ­Œè¯æ˜¾ç¤ºäº‹ä»¶è§¦å‘');
        if (lyricsVisible) {
          startEnhancedLyricsListener(aplayer);
        }
      });

      aplayer.on('lrchide', function() {
        console.log('æ­Œè¯éšè—äº‹ä»¶è§¦å‘');
        stopLyricsListener();
      });

      // æ›´æ–°èƒ¶å›Šå°é¢
      function updateCover() {
        try {
          const currentAudio = aplayer.list.audios[aplayer.list.index];
          if (currentAudio && currentAudio.cover && capsuleCover) {
            capsuleCover.src = currentAudio.cover;
          }
        } catch(e) {
          console.log('æ›´æ–°å°é¢å¤±è´¥:', e);
        }
      }

      // æ›´æ–°æ­Œè¯æ˜¾ç¤º
      function updateLyrics(current, next) {
        if (!currentLineEl || !nextLineEl || !lyricsVisible) return;
        
        currentLineEl.textContent = current || '';
        nextLineEl.textContent = next || '';
        
        if (current && lyricsVisible) {
          floatingLyrics.classList.add('show');
        } else {
          floatingLyrics.classList.remove('show');
        }
      }

      // å¢å¼ºç‰ˆæ­Œè¯ç›‘å¬
      function startEnhancedLyricsListener(aplayerInstance) {
        // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬å™¨
        stopLyricsListener();
        
        console.log('å¼€å§‹å¢å¼ºæ­Œè¯ç›‘å¬');
        
        lyricsUpdateInterval = setInterval(() => {
          if (!lyricsVisible || !aplayerInstance) {
            updateLyrics('', '');
            return;
          }
          
          try {
            // æ–¹æ³•1: ç›´æ¥ä»APlayerå®ä¾‹è·å–æ­Œè¯æ•°æ®
            if (aplayerInstance.lrc && aplayerInstance.lrc.lrc) {
              const currentTime = aplayerInstance.audio.currentTime;
              const lrcData = aplayerInstance.lrc.lrc;
              
              let currentText = '';
              let nextText = '';
              let foundCurrent = false;
              
              // è·å–æ‰€æœ‰æ—¶é—´ç‚¹å¹¶æ’åº
              const times = Object.keys(lrcData).map(Number).sort((a, b) => a - b);
              
              for (let i = 0; i < times.length; i++) {
                if (currentTime >= times[i]) {
                  currentText = lrcData[times[i]] || '';
                  foundCurrent = true;
                  
                  // æ‰¾ä¸‹ä¸€å¥æ­Œè¯
                  if (i < times.length - 1) {
                    nextText = lrcData[times[i + 1]] || '';
                  }
                } else if (foundCurrent) {
                  break;
                }
              }
              
              if (currentText !== currentLyric) {
                currentLyric = currentText;
                updateLyrics(currentText, nextText);
              }
              return;
            }
            
            // æ–¹æ³•2: ä»DOMå…ƒç´ è·å–æ­Œè¯
            let lrcContainer = document.querySelector('.aplayer-lrc') || 
                              document.querySelector('.aplayer-lrc-contents') ||
                              document.querySelector('.aplayer .aplayer-lrc-contents');
            
            if (lrcContainer) {
              const currentLrc = lrcContainer.querySelector('p.aplayer-lrc-current');
              const allLrcLines = lrcContainer.querySelectorAll('p');
              
              if (currentLrc && currentLrc.textContent && currentLrc.textContent.trim()) {
                const currentText = currentLrc.textContent.trim();
                let nextText = '';
                
                // æ‰¾åˆ°ä¸‹ä¸€å¥æ­Œè¯
                for (let i = 0; i < allLrcLines.length; i++) {
                  if (allLrcLines[i] === currentLrc && i < allLrcLines.length - 1) {
                    const nextLrc = allLrcLines[i + 1];
                    if (nextLrc && nextLrc.textContent) {
                      nextText = nextLrc.textContent.trim();
                    }
                    break;
                  }
                }
                
                if (currentText !== currentLyric) {
                  currentLyric = currentText;
                  updateLyrics(currentText, nextText);
                }
              } else {
                updateLyrics('', '');
                currentLyric = '';
              }
            } else {
              updateLyrics('', '');
              currentLyric = '';
            }
          } catch (error) {
            console.log('æ­Œè¯ç›‘å¬é”™è¯¯:', error);
            updateLyrics('', '');
          }
        }, 150); // ä¼˜åŒ–æ£€æŸ¥é¢‘ç‡
      }

      // åœæ­¢æ­Œè¯ç›‘å¬
      function stopLyricsListener() {
        if (lyricsUpdateInterval) {
          clearInterval(lyricsUpdateInterval);
          lyricsUpdateInterval = null;
        }
      }

      // åˆå§‹å¯åŠ¨æ­Œè¯ç›‘å¬
      if (lyricsVisible) {
        setTimeout(() => {
          startEnhancedLyricsListener(aplayer);
        }, 1000);
      }
      
      // åˆå§‹æ›´æ–°æ­Œè¯æ˜¾ç¤ºçŠ¶æ€
      updateLyricsDisplay();
    }

    // ä½ çš„åŸæœ‰ APlayer åŠ è½½ä»£ç ï¼ˆä¿æŒä¸å˜ï¼‰
    function loadAPlayer() {
      return new Promise((resolve) => {
        if (window.APlayer) {
          resolve(window.APlayer);
          return;
        }
        const aplayerScript = document.createElement("script");
        aplayerScript.src = aplayerJsPath;
        aplayerScript.async = true;
        aplayerScript.onload = () => resolve(window.APlayer);
        aplayerScript.onerror = () => {
          console.error("Failed to load APlayer");
          resolve(null);
        };
        document.head.appendChild(aplayerScript);
      });
    }

    // å…¨å±€ç”¨æˆ·äº¤äº’çŠ¶æ€
    if (!window.hasMusicInteracted) {
      window.hasMusicInteracted = false;
    }
    
    function tryAutoplay(aplayer) {
      if (!config.player?.autoplay) return;
      
      if (window.hasMusicInteracted) {
        if (aplayer && aplayer.paused) {
          const playPromise = aplayer.play();
          if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch((error) => {
              if (error.name !== 'NotAllowedError') {
                console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error.name);
              }
            });
          }
        }
      } else {
        const enableAutoplay = () => {
          if (window.hasMusicInteracted) return;
          window.hasMusicInteracted = true;
          
          if (aplayer && aplayer.paused) {
            const playPromise = aplayer.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch((error) => {
                if (error.name !== 'NotAllowedError') {
                  console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error.name);
                }
              });
            }
          }
        };
        
        ['click', 'keydown', 'touchstart', 'scroll'].forEach(eventType => {
          document.addEventListener(eventType, enableAutoplay, { 
            once: true, 
            passive: true 
          });
        });
      }
    }

    // æ£€æŸ¥ MetingJS å…ƒç´ æ˜¯å¦æˆåŠŸåŠ è½½äº†éŸ³ä¹
    function checkMetingSuccess(metingElement, timeout = 5000) {
      return new Promise((resolve) => {
        const startTime = Date.now();
        
        const checkSuccess = setInterval(() => {
          const aplayer = metingElement?.aplayer;
          if (aplayer && aplayer.list && aplayer.list.audios && aplayer.list.audios.length > 0) {
            clearInterval(checkSuccess);
            resolve(true);
            return;
          }
          
          if (Date.now() - startTime >= timeout) {
            clearInterval(checkSuccess);
            resolve(false);
          }
        }, 100);
      });
    }

    // é‡æ–°åˆ›å»º MetingJS å…ƒç´ ä»¥ä½¿ç”¨æ–°çš„ API
    function recreateMetingElement(container, apiUrl, config) {
      const oldElement = container.querySelector('meting-js');
      if (oldElement) {
        if (oldElement.aplayer) {
          try {
            oldElement.aplayer.destroy();
          } catch (e) {
            console.warn('é”€æ¯æ—§ APlayer å®ä¾‹æ—¶å‡ºé”™:', e);
          }
        }
        oldElement.remove();
      }
      
      const newElement = document.createElement('meting-js');
      newElement.setAttribute('server', config.meting?.server || 'netease');
      newElement.setAttribute('type', config.meting?.type || 'playlist');
      newElement.setAttribute('id', config.meting?.id || '');
      newElement.setAttribute('api', apiUrl);
      if (config.meting?.auth) {
        newElement.setAttribute('auth', config.meting.auth);
      }
      newElement.setAttribute('fixed', (config.player?.fixed ?? true) ? 'true' : 'false');
      newElement.setAttribute('mini', (config.player?.mini ?? true) ? 'true' : 'false');
      newElement.setAttribute('autoplay', config.player?.autoplay ? 'true' : 'false');
      newElement.setAttribute('theme', config.player?.theme || '#b7daff');
      newElement.setAttribute('loop', config.player?.loop || 'all');
      newElement.setAttribute('order', config.player?.order || 'list');
      newElement.setAttribute('preload', config.player?.preload || 'auto');
      newElement.setAttribute('volume', String(config.player?.volume ?? 0.7));
      newElement.setAttribute('mutex', config.player?.mutex !== false ? 'true' : 'false');
      newElement.setAttribute('lrc-type', String(config.player?.lrcType ?? 3));
      newElement.setAttribute('list-folded', config.player?.listFolded ? 'true' : 'false');
      newElement.setAttribute('list-max-height', config.player?.listMaxHeight || '340px');
      newElement.setAttribute('storage-name', config.player?.storageName || 'aplayer-setting');
      
      container.appendChild(newElement);
      return newElement;
    }

    // å¤„ç†ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—
    function handleMobileVisibility(aplayer) {
      if (!aplayer || !aplayer.container) return;
      
      const shouldHide = config.responsive?.mobile?.hide === true;
      const breakpoint = config.responsive?.mobile?.breakpoint || 768;
      const isMobile = window.innerWidth <= breakpoint;
      
      if (shouldHide && isMobile) {
        aplayer.container.style.display = 'none';
        aplayer.container.classList.add('mobile-hide');
        
        const container = document.getElementById('aplayer-container');
        if (container) {
          container.style.display = 'none';
          container.classList.add('mobile-hide');
        }
      } else {
        aplayer.container.style.display = '';
        aplayer.container.classList.remove('mobile-hide');
        
        const container = document.getElementById('aplayer-container');
        if (container) {
          container.style.display = '';
          container.classList.remove('mobile-hide');
        }
      }
    }
    
    // åˆå§‹åŒ–æ—¶å¤„ç†å®¹å™¨çš„ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—
    function initContainerMobileVisibility() {
      const container = document.getElementById('aplayer-container');
      if (!container) return;
      
      const shouldHide = config.responsive?.mobile?.hide === true;
      const breakpoint = config.responsive?.mobile?.breakpoint || 768;
      const isMobile = window.innerWidth <= breakpoint;
      
      if (shouldHide && isMobile) {
        container.style.display = 'none';
        container.classList.add('mobile-hide');
      } else {
        container.style.display = '';
        container.classList.remove('mobile-hide');
      }
      
      const resizeHandler = () => {
        const nowIsMobile = window.innerWidth <= breakpoint;
        if (shouldHide && nowIsMobile) {
          container.style.display = 'none';
          container.classList.add('mobile-hide');
        } else {
          container.style.display = '';
          container.classList.remove('mobile-hide');
        }
      };
      window.addEventListener('resize', resizeHandler);
    }

    // åˆå§‹åŒ– MetingJS å…ƒç´ å¹¶è®¾ç½®æ’­æ”¾å™¨
    function setupMetingElement(metingElement) {
      return new Promise((resolve) => {
        const checkAPlayer = setInterval(() => {
          const aplayer = metingElement.aplayer;
          if (aplayer && aplayer.container) {
            clearInterval(checkAPlayer);
            
            const updatePlayingState = () => {
              if (aplayer.container) {
                const isPlaying = !aplayer.paused;
                aplayer.container.setAttribute('data-playing', String(isPlaying));
                if (isPlaying) {
                  aplayer.container.classList.add('aplayer-playing');
                } else {
                  aplayer.container.classList.remove('aplayer-playing');
                }
              }
            };
            
            if (aplayer.audio) {
              aplayer.audio.addEventListener('play', updatePlayingState);
              aplayer.audio.addEventListener('pause', updatePlayingState);
              aplayer.audio.addEventListener('ended', updatePlayingState);
            }
            
            aplayer.container.setAttribute('data-positioned', 'right');
            requestAnimationFrame(() => {
              if (aplayer.container) {
                aplayer.container.style.right = '0';
                aplayer.container.style.left = 'unset';
                
                updatePlayingState();
                handleMobileVisibility(aplayer);
                
                const resizeHandler = () => handleMobileVisibility(aplayer);
                window.addEventListener('resize', resizeHandler);
                
                setTimeout(() => {
                  aplayer.container.setAttribute('data-initialized', 'true');
                  
                  // ç¡®ä¿æ­Œè¯åŠŸèƒ½æ­£ç¡®åˆå§‹åŒ–
                  if (config.player?.lrcType !== 0 && aplayer.lrc) {
                    setTimeout(() => {
                      if (aplayer.lrc) {
                        aplayer.lrc.show();
                        // ç¡®ä¿æ­Œè¯å®¹å™¨å¯è§
                        const lrcContainer = aplayer.container.querySelector('.aplayer-lrc');
                        if (lrcContainer) {
                          lrcContainer.style.display = 'block';
                        }
                        console.log('æ­Œè¯åŠŸèƒ½å·²åˆå§‹åŒ–');
                      }
                    }, 500);
                  }
                  
                  if (config.player?.autoplay && aplayer.paused) {
                    tryAutoplay(aplayer);
                  }

                  // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
                  initAllFeatures();
                }, 200);
              }
            });
            
            resolve(true);
          }
        }, 50);
        
        setTimeout(() => {
          clearInterval(checkAPlayer);
          resolve(false);
        }, 10000);
      });
    }

    // ä½¿ç”¨å¤‡ç”¨ API é‡è¯•åŠ è½½
    async function retryWithFallbackAPI(container, fallbackApis, currentIndex = 0) {
      if (currentIndex >= fallbackApis.length) {
        console.error('æ‰€æœ‰ API éƒ½å¤±è´¥äº†ï¼Œæ— æ³•åŠ è½½éŸ³ä¹æ’­æ”¾å™¨');
        return null;
      }
      
      const fallbackApi = fallbackApis[currentIndex];
      console.log(`å°è¯•ä½¿ç”¨å¤‡ç”¨ API ${currentIndex + 1}/${fallbackApis.length}: ${fallbackApi}`);
      
      const server = config.meting?.server || 'netease';
      const type = config.meting?.type || 'playlist';
      const id = config.meting?.id || '';
      
      let apiUrl = fallbackApi
        .replace(':server', server)
        .replace(':type', type)
        .replace(':id', id);
      
      window.meting_api = apiUrl;
      
      const newElement = recreateMetingElement(container, apiUrl, config);
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const success = await checkMetingSuccess(newElement, 5000);
      
      if (success) {
        console.log(`å¤‡ç”¨ API ${currentIndex + 1} æˆåŠŸåŠ è½½éŸ³ä¹`);
        return newElement;
      } else {
        return retryWithFallbackAPI(container, fallbackApis, currentIndex + 1);
      }
    }

    // åŠ è½½ MetingJS
    function loadMetingJS() {
      return new Promise((resolve) => {
        if (window.customElements?.get("meting-js")) {
          resolve(true);
          return;
        }

        const metingScript = document.createElement("script");
        metingScript.src = metingJsPath;
        metingScript.async = true;
        metingScript.onload = async () => {
          await new Promise(resolve => setTimeout(resolve, 100));
          
          const container = document.getElementById('aplayer-container');
          if (!container) {
            resolve(false);
            return;
          }
          
          let metingElement = container.querySelector('meting-js');
          
          if (config.mode === "meting" && config.meting?.api && metingElement) {
            const server = config.meting.server || 'netease';
            const type = config.meting.type || 'playlist';
            const id = config.meting.id || '';
            
            let mainApiUrl = config.meting.api
              .replace(':server', server)
              .replace(':type', type)
              .replace(':id', id)
              .replace(':r', Math.random().toString());
            
            window.meting_api = mainApiUrl;
            
            console.log('å°è¯•ä½¿ç”¨ä¸» API:', mainApiUrl);
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const mainApiSuccess = await checkMetingSuccess(metingElement, 5000);
            
            if (!mainApiSuccess && config.meting.fallbackApis && config.meting.fallbackApis.length > 0) {
              console.warn('ä¸» API å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ API');
              const newElement = await retryWithFallbackAPI(container, config.meting.fallbackApis);
              if (newElement) {
                metingElement = newElement;
              }
            }
          }
          
          if (metingElement) {
            await setupMetingElement(metingElement);
          }
          
          resolve(true);
        };
        metingScript.onerror = () => {
          console.error("Failed to load MetingJS");
          resolve(false);
        };
        document.head.appendChild(metingScript);
      });
    }

    // åˆå§‹åŒ–æœ¬åœ°éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå¤šä¸ªéŸ³ä¹ï¼‰
    async function initLocalPlayer() {
      if (
        config.mode !== "local" ||
        !processedLocalPlaylist ||
        processedLocalPlaylist.length <= 1
      ) {
        return;
      }

      const APlayerClass = await loadAPlayer();
      if (!APlayerClass) return;

      const container = document.getElementById("local-aplayer");
      if (!container) return;

      const audioList = processedLocalPlaylist.map((song) => ({
        name: song.name,
        artist: song.artist,
        url: song.url,
        cover: song.cover,
        lrc: song.lrc || undefined,
        type: "auto",
      }));

      const aplayerOptions = {
        container: container,
        audio: audioList,
        mutex: config.player?.mutex !== false,
        lrcType: config.player?.lrcType !== undefined ? config.player.lrcType : 0,
        fixed: config.player?.fixed ?? true,
        mini: config.player?.mini ?? true,
        autoplay: config.player?.autoplay || false,
        theme: config.player?.theme || "#b7daff",
        loop: config.player?.loop || "all",
        order: config.player?.order || "list",
        preload: config.player?.preload || "auto",
        volume: config.player?.volume || 0.7,
        listFolded: config.player?.listFolded || false,
        listMaxHeight: config.player?.listMaxHeight || "340px",
        storageName: config.player?.storageName || "aplayer-setting",
      };

      try {
        const aplayer = new APlayerClass(aplayerOptions);
        
        const updatePlayingState = () => {
          if (aplayer.container) {
            const isPlaying = !aplayer.paused;
            aplayer.container.setAttribute('data-playing', String(isPlaying));
            if (isPlaying) {
              aplayer.container.classList.add('aplayer-playing');
            } else {
              aplayer.container.classList.remove('aplayer-playing');
            }
          }
        };
        
        if (aplayer.audio) {
          aplayer.audio.addEventListener('play', updatePlayingState);
          aplayer.audio.addEventListener('pause', updatePlayingState);
          aplayer.audio.addEventListener('ended', updatePlayingState);
        }
        
        if (aplayer.container) {
          aplayer.container.setAttribute('data-positioned', 'right');
          requestAnimationFrame(() => {
            if (aplayer.container) {
              aplayer.container.style.right = '0';
              aplayer.container.style.left = 'unset';
              
              updatePlayingState();
              handleMobileVisibility(aplayer);
              
              const resizeHandler = () => handleMobileVisibility(aplayer);
              window.addEventListener('resize', resizeHandler);
              
              setTimeout(() => {
                aplayer.container.setAttribute('data-initialized', 'true');
                
                // ç¡®ä¿æ­Œè¯åŠŸèƒ½æ­£ç¡®åˆå§‹åŒ–
                if (config.player?.lrcType !== 0 && aplayer.lrc) {
                  setTimeout(() => {
                    if (aplayer.lrc) {
                      aplayer.lrc.show();
                      const lrcContainer = aplayer.container.querySelector('.aplayer-lrc');
                      if (lrcContainer) {
                        lrcContainer.style.display = 'block';
                      }
                      console.log('æœ¬åœ°æ’­æ”¾å™¨æ­Œè¯åŠŸèƒ½å·²åˆå§‹åŒ–');
                    }
                  }, 500);
                }
                
                if (config.player?.autoplay && aplayer.paused) {
                  tryAutoplay(aplayer);
                }

                // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
                initAllFeatures();
              }, 100);
            }
          });
        }
      } catch (error) {
        console.error("Failed to initialize APlayer:", error);
      }
    }

    // åˆå§‹åŒ–å®¹å™¨çš„ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initContainerMobileVisibility);
    } else {
      initContainerMobileVisibility();
    }
    
    // å¦‚æœä½¿ç”¨ Meting æ¨¡å¼ï¼ŒåŠ è½½ MetingJS
    if (config.mode === "meting") {
      loadAPlayer().then(() => {
        loadMetingJS();
      });
    } else if (config.mode === "local") {
      if (processedLocalPlaylist && processedLocalPlaylist.length > 1) {
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initLocalPlayer);
        } else {
          initLocalPlayer();
        }
      } else {
        loadAPlayer().then(() => {
          loadMetingJS();
        });
      }
    }

    // è°ƒè¯•å‡½æ•°
    window.debugLyrics = function() {
      const aplayer = getAPlayerInstance();
      console.log('=== æ­Œè¯è°ƒè¯•ä¿¡æ¯ ===');
      console.log('APlayerå®ä¾‹:', aplayer);
      console.log('æ­Œè¯å®ä¾‹:', aplayer ? aplayer.lrc : 'æ— æ’­æ”¾å™¨');
      console.log('æ­Œè¯æ•°æ®:', aplayer && aplayer.lrc ? aplayer.lrc.lrc : 'æ— æ­Œè¯æ•°æ®');
      console.log('æ­Œè¯å®¹å™¨:', document.querySelector('.aplayer-lrc'));
      console.log('æµ®åŠ¨æ­Œè¯å…ƒç´ :', document.getElementById('floating-lyrics'));
      console.log('æ­Œè¯æ˜¾ç¤ºçŠ¶æ€:', lyricsVisible);
      console.log('å½“å‰æ­Œè¯:', document.querySelector('.current-line')?.textContent);
      console.log('==================');
    };
  })();
</script>

<style>
  /* åŸæœ‰æ’­æ”¾å™¨æ ·å¼ä¿æŒä¸å˜ */
  #aplayer-container {
    position: relative;
    z-index: 1000;
  }

  #aplayer-container .aplayer-fixed {
    z-index: 9999;
  }

  #aplayer-container .aplayer.aplayer-fixed {
    animation: none !important;
  }
  
  #aplayer-container .aplayer.aplayer-fixed .aplayer-body {
    animation: none !important;
    transition: none !important;
  }
  
  #aplayer-container .aplayer.aplayer-fixed[data-positioned="right"] {
    right: 0 !important;
    left: unset !important;
  }

  .aplayer-fixed.mobile-hide {
    display: none !important;
  }
  
  #aplayer-container.mobile-hide {
    display: none !important;
  }

  /* éŸ³ä¹èƒ¶å›Šæ ·å¼ */
  .music-capsule {
    position: fixed;
    left: 22px;
    bottom: 96px;
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 30000;
    background: radial-gradient(circle at 30% 30%, #00c3ff, #0061ff);
    box-shadow: 0 8px 28px rgba(0, 180, 255, 0.12);
    transition: all 0.3s ease;
  }

  .music-capsule:hover {
    transform: scale(1.05);
  }

  .music-capsule img {
    width: 64%;
    height: 64%;
    border-radius: 50%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .music-capsule.playing {
    background: radial-gradient(circle at 30% 30%, #ff9500, #ff5e00);
    box-shadow: 0 8px 28px rgba(255, 140, 0, 0.28);
  }

  .music-capsule.playing img {
    animation: spin 6s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0) }
    to { transform: rotate(360deg) }
  }

  /* ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º */
  .floating-lyrics {
    position: fixed;
    left: 100px;
    bottom: 50px;
    text-align: left;
    z-index: 99999;
    color: #ff8c00;
    font-size: 18px;
    font-weight: bold;
    text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9);
    background: rgba(255, 255, 255, 0.10);
    padding: 15px 20px;
    border-radius: 12px;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    max-width: 400px;
    opacity: 0;
    transition: opacity 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    pointer-events: none;
    display: none;
  }

  .floating-lyrics.show {
    opacity: 1;
  }

  .floating-lyrics .current-line {
    color: #ff4500;
    font-size: 30px;
    margin-bottom: 8px;
    font-weight: bold;
    min-height: 24px;
  }

  .floating-lyrics .next-line {
    color: #ff8c00;
    font-size: 14px;
    opacity: 0.8;
    min-height: 18px;
  }

  /* å³é”®èœå• */
  #right-menu{
    position:fixed;
    display:none;
    z-index:40000;
    min-width:220px;
    background:rgba(255,255,255,0.12);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    color:#fff;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,0.35);
    padding:6px 0;
    opacity:0;
    transform:scale(.98);
    transition:opacity .12s,transform .12s
  }
  #right-menu.show{
    display:flex;
    opacity:1;
    transform:scale(1);
    flex-direction:column
  }
  #right-menu li{
    list-style:none;
    padding:10px 16px;
    cursor:pointer;
    white-space:nowrap;
    font-weight:700;
    transition:background .12s
  }
  #right-menu li:hover{
    background:rgba(255,255,255,0.14);
    color:#f97316;
    border-radius:6px
  }
  #right-menu::after{
    content:"";
    position:absolute;
    top:-8px;
    left:var(--arrow-left,24px);
    transform:translateX(-50%);
    border-left:8px solid transparent;
    border-right:8px solid transparent;
    border-bottom:8px solid rgba(255,255,255,0.12)
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .music-capsule {
      left: 18px;
      bottom: 22px;
      width: 60px;
      height: 60px;
    }
    
    .floating-lyrics {
      left: 90px;
      bottom: 30px;
      max-width: 250px;
      font-size: 16px;
    }
    
    .floating-lyrics .current-line {
      font-size: 18px;
    }
    
    .floating-lyrics .next-line {
      font-size: 12px;
    }
  }
</style>
