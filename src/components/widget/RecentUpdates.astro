---
import { getCollection } from 'astro:content';
import ButtonLink from "@/components/control/ButtonLink.astro";
import WidgetLayout from "./WidgetLayout.astro";

// 从 posts 集合获取文章
let posts = await getCollection('posts');

// 调试封面图片信息
console.log('=== 封面图片调试信息 ===');
posts.forEach(post => {
  console.log(`文章: ${post.data.title}`, {
    image: post.data.image,
    hasImage: !!post.data.image
  });
});

// 按发布时间排序
posts = posts.sort((a, b) => {
  const getDate = (post) => {
    if (post.data.pubDate) return new Date(post.data.pubDate);
    if (post.data.date) return new Date(post.data.date);
    if (post.data.published) return new Date(post.data.published);
    return new Date(0);
  };
  
  const dateA = getDate(a);
  const dateB = getDate(b);
  return dateB.getTime() - dateA.getTime();
});

// 过滤掉草稿文章
const publishedPosts = posts.filter(post => !post.data.draft);
const recentPosts = publishedPosts.slice(0, 5);

function getRelativeTime(date) {
  const now = new Date();
  const diffTime = Math.abs(now - new Date(date));
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 1) return '今天';
  if (diffDays === 2) return '昨天';
  if (diffDays <= 7) return `${diffDays}天前`;
  if (diffDays <= 30) return `${Math.ceil(diffDays / 7)}周前`;
  return `${Math.ceil(diffDays / 30)}月前`;
}

function getDisplayDate(post) {
  if (post.data.pubDate) return post.data.pubDate;
  if (post.data.date) return post.data.date;
  if (post.data.published) return post.data.published;
  return post.data.published;
}

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout name="近期更新" id="recent-updates" isCollapsed={false} collapsedHeight="10rem"
                class={className} style={style}
>
    {recentPosts.length > 0 ? (
      recentPosts.map((post, index) => {
        const isNew = index === 0;
        const displayDate = getDisplayDate(post);
        const isRecent = new Date(displayDate) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const coverImage = post.data.image; // 直接使用 image 字段
        
        return (
          <ButtonLink
            url={`/posts/${post.slug}`}
            badge={isNew ? "新" : (isRecent ? "最新" : "")}
            label={`阅读文章: ${post.data.title}`}
          >
            <div class="flex items-start gap-3 w-full">
              <!-- 封面图片 -->
              {coverImage && (
                <div class="flex-shrink-0 w-12 h-12 rounded-md overflow-hidden border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800">
                  <img 
                    src={coverImage} 
                    alt={post.data.title}
                    class="w-full h-full object-cover"
                    loading="lazy"
                    onerror="this.style.display='none'" <!-- 图片加载失败时隐藏 -->
                  />
                </div>
              )}
              
              <!-- 文字内容 -->
              <div class="flex-1 min-w-0">
                <span class="text-sm font-medium leading-tight text-left block line-clamp-2">
                  {post.data.title}
                </span>
                <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                  {getRelativeTime(displayDate)}
                </span>
              </div>
            </div>
          </ButtonLink>
        );
      })
    ) : (
      <div class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
        {posts.length === 0 ? '未找到文章内容' : `暂无文章更新（总文章数: ${posts.length}，已发布: ${publishedPosts.length}）`}
      </div>
    )}
</WidgetLayout>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
