---
import { getCollection } from 'astro:content';
import ButtonLink from "@/components/control/ButtonLink.astro";
import WidgetLayout from "./WidgetLayout.astro";

// 获取最新的文章
let posts = await getCollection('blog');

// 详细的调试信息
console.log('=== 近期更新组件调试信息 ===');
console.log('1. 获取到的文章集合:', posts);
console.log('2. 文章数量:', posts.length);
console.log('3. 每篇文章的详细信息:');
posts.forEach((post, index) => {
  console.log(`   文章 ${index + 1}:`, {
    title: post.data.title,
    slug: post.slug,
    id: post.id,
    published: post.data.published,
    date: post.data.date,
    pubDate: post.data.pubDate,
    draft: post.data.draft,
    collection: post.collection
  });
});

// 检查集合名称和内容目录
console.log('4. 尝试获取所有集合:');
try {
  const allCollections = await getCollection();
  console.log('   所有集合:', allCollections);
} catch (e) {
  console.log('   获取集合失败:', e);
}

// 按发布时间排序 - 优先级：pubDate > date > published
posts = posts.sort((a, b) => {
  const getDate = (post) => {
    if (post.data.pubDate) return new Date(post.data.pubDate);
    if (post.data.date) return new Date(post.data.date);
    if (post.data.published) return new Date(post.data.published);
    return new Date(0);
  };
  
  const dateA = getDate(a);
  const dateB = getDate(b);
  return dateB.getTime() - dateA.getTime();
});

// 过滤掉草稿文章
const publishedPosts = posts.filter(post => !post.data.draft);
const recentPosts = publishedPosts.slice(0, 5);

console.log('5. 处理后的文章:', {
  排序后文章数: posts.length,
  过滤草稿后: publishedPosts.length,
  最终显示: recentPosts.length,
  最终文章列表: recentPosts.map(p => p.data.title)
});

function getRelativeTime(date) {
  const now = new Date();
  const diffTime = Math.abs(now - new Date(date));
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 1) return '今天';
  if (diffDays === 2) return '昨天';
  if (diffDays <= 7) return `${diffDays}天前`;
  if (diffDays <= 30) return `${Math.ceil(diffDays / 7)}周前`;
  return `${Math.ceil(diffDays / 30)}月前`;
}

function getDisplayDate(post) {
  if (post.data.pubDate) return post.data.pubDate;
  if (post.data.date) return post.data.date;
  if (post.data.published) return post.data.published;
  return post.data.published;
}

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout name="近期更新" id="recent-updates" isCollapsed={false} collapsedHeight="7.5rem"
                class={className} style={style}
>
    {recentPosts.length > 0 ? (
      recentPosts.map((post, index) => {
        const isNew = index === 0;
        const displayDate = getDisplayDate(post);
        const isRecent = new Date(displayDate) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        
        console.log(`渲染文章: ${post.data.title}`, {
          isNew, isRecent, displayDate
        });
        
        return (
          <ButtonLink
            url={`/blog/${post.slug}`}
            badge={isNew ? "新" : (isRecent ? "最新" : "")}
            label={`阅读文章: ${post.data.title}`}
          >
            <div class="flex flex-col items-start gap-1">
              <span class="text-sm font-medium leading-tight text-left">
                {post.data.title}
              </span>
              <span class="text-xs text-gray-500 dark:text-gray-400">
                {getRelativeTime(displayDate)}
              </span>
            </div>
          </ButtonLink>
        );
      })
    ) : (
      <div class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
        暂无文章更新（总文章数: {posts.length}，已发布: {publishedPosts.length}）
      </div>
    )}
</WidgetLayout>
