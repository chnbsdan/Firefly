---
import { getCollection } from 'astro:content';
import ButtonLink from "@/components/control/ButtonLink.astro";
import WidgetLayout from "./WidgetLayout.astro";

// 获取最新的文章
let posts = await getCollection('blog');

// 调试：打印获取到的文章信息
console.log('获取到的文章:', posts.map(p => ({
  title: p.data.title,
  slug: p.slug,
  published: p.data.published,
  draft: p.data.draft
})));

// 按发布时间排序 - 修正字段名
posts = posts.sort((a, b) => {
  const dateA = new Date(a.data.published || a.data.pubDate); // 优先使用 published
  const dateB = new Date(b.data.published || b.data.pubDate);
  return dateB.getTime() - dateA.getTime();
});

const recentPosts = posts.slice(0, 5);

function getRelativeTime(date) {
  const now = new Date();
  const diffTime = Math.abs(now - new Date(date));
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 1) return '今天';
  if (diffDays === 2) return '昨天';
  if (diffDays <= 7) return `${diffDays}天前`;
  if (diffDays <= 30) return `${Math.ceil(diffDays / 7)}周前`;
  return `${Math.ceil(diffDays / 30)}月前`;
}

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout name="近期更新" id="recent-updates" isCollapsed={false} collapsedHeight="7.5rem"
                class={className} style={style}
>
    {recentPosts.length > 0 ? (
      recentPosts.map((post, index) => {
        const isNew = index === 0;
        // 检查是否是一周内发布的文章
        const isRecent = new Date(post.data.published) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        
        return (
          <ButtonLink
            url={`/blog/${post.slug}`}
            badge={isNew ? "新" : (isRecent ? "最新" : "")}
            label={`阅读文章: ${post.data.title}`}
          >
            <div class="flex flex-col items-start gap-1">
              <span class="text-sm font-medium leading-tight text-left">
                {post.data.title}
              </span>
              <span class="text-xs text-gray-500 dark:text-gray-400">
                {getRelativeTime(post.data.published)}
              </span>
            </div>
          </ButtonLink>
        );
      })
    ) : (
      <div class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
        暂无文章更新
      </div>
    )}
</WidgetLayout>
