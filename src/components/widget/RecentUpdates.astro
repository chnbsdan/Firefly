---
import { getCollection } from 'astro:content';
import ButtonLink from "@/components/control/ButtonLink.astro";
import WidgetLayout from "./WidgetLayout.astro";

// ä» posts é›†åˆè·å–æ–‡ç« 
let posts = await getCollection('posts');

// å¤„ç†å°é¢å›¾ç‰‡è·¯å¾„
function getCoverImage(post) {
  const imageField = post.data.image;
  
  console.log(`æ–‡ç«  "${post.data.title}" çš„å›¾ç‰‡å­—æ®µ:`, imageField);
  
  // å¦‚æœæ˜¯APIå­—ç¬¦ä¸²ï¼Œè¿”å›ç©º
  if (imageField === 'api') {
    console.log(`  -> æ£€æµ‹åˆ°APIå­—æ®µï¼Œè¿”å›ç©º`);
    return null;
  }
  
  // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ (./cover.webp)
  if (imageField && imageField.startsWith('./')) {
    const imageName = imageField.replace('./', '');
    // å‡è®¾å›¾ç‰‡ä¸æ–‡ç« åœ¨åŒä¸€ç›®å½•ï¼Œæ„å»ºç›¸å¯¹è·¯å¾„
    const imagePath = `/posts/${post.slug}/${imageName}`;
    console.log(`  -> ç›¸å¯¹è·¯å¾„è½¬æ¢: ${imageField} -> ${imagePath}`);
    return imagePath;
  }
  
  // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ (cover.webp) - æ²¡æœ‰ ./
  if (imageField && !imageField.startsWith('/') && !imageField.startsWith('http') && !imageField.startsWith('./')) {
    const imagePath = `/posts/${post.slug}/${imageField}`;
    console.log(`  -> ç›¸å¯¹è·¯å¾„è½¬æ¢: ${imageField} -> ${imagePath}`);
    return imagePath;
  }
  
  // å¦‚æœæ˜¯ç»å¯¹è·¯å¾„æˆ–å®Œæ•´URLï¼Œç›´æ¥è¿”å›
  if (imageField && (imageField.startsWith('/') || imageField.startsWith('http'))) {
    console.log(`  -> ç»å¯¹è·¯å¾„æˆ–URL: ${imageField}`);
    return imageField;
  }
  
  console.log(`  -> æ— æ³•è¯†åˆ«çš„å›¾ç‰‡æ ¼å¼ï¼Œè¿”å›ç©º`);
  return null;
}

// æŒ‰å‘å¸ƒæ—¶é—´æ’åº
posts = posts.sort((a, b) => {
  const getDate = (post) => {
    if (post.data.pubDate) return new Date(post.data.pubDate);
    if (post.data.date) return new Date(post.data.date);
    if (post.data.published) return new Date(post.data.published);
    return new Date(0);
  };
  
  const dateA = getDate(a);
  const dateB = getDate(b);
  return dateB.getTime() - dateA.getTime();
});

// è¿‡æ»¤æ‰è‰ç¨¿æ–‡ç« 
const publishedPosts = posts.filter(post => !post.data.draft);
const recentPosts = publishedPosts.slice(0, 5);

console.log('=== è¿‘æœŸæ›´æ–°ç»„ä»¶å¤„ç†ç»“æœ ===');
console.log('æ€»æ–‡ç« æ•°:', posts.length);
console.log('å·²å‘å¸ƒæ–‡ç« æ•°:', publishedPosts.length);
console.log('æ˜¾ç¤ºæ–‡ç« æ•°:', recentPosts.length);

// è®¡ç®—ç›¸å¯¹æ—¶é—´
function getRelativeTime(date) {
  const now = new Date();
  const diffTime = Math.abs(now - new Date(date));
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 1) return 'ä»Šå¤©';
  if (diffDays === 2) return 'æ˜¨å¤©';
  if (diffDays <= 7) return `${diffDays}å¤©å‰`;
  if (diffDays <= 30) return `${Math.ceil(diffDays / 7)}å‘¨å‰`;
  return `${Math.ceil(diffDays / 30)}æœˆå‰`;
}

function getDisplayDate(post) {
  if (post.data.pubDate) return post.data.pubDate;
  if (post.data.date) return post.data.date;
  if (post.data.published) return post.data.published;
  return post.data.published;
}

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout name="è¿‘æœŸæ›´æ–°" id="recent-updates" isCollapsed={false} collapsedHeight="10rem"
                class={className} style={style}
>
    {recentPosts.length > 0 ? (
      recentPosts.map((post, index) => {
        const isNew = index === 0;
        const displayDate = getDisplayDate(post);
        const isRecent = new Date(displayDate) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const coverImage = getCoverImage(post);
        
        return (
          <ButtonLink
            url={`/posts/${post.slug}`}
            badge={isNew ? "æ–°" : (isRecent ? "æœ€æ–°" : "")}
            label={`é˜…è¯»æ–‡ç« : ${post.data.title}`}
          >
            <div class="flex items-start gap-3 w-full">
              <!-- å°é¢å›¾ç‰‡åŒºåŸŸ -->
              <div class="flex-shrink-0 w-12 h-12 rounded-md overflow-hidden border border-gray-200 dark:border-gray-700 bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900 dark:to-purple-900 flex items-center justify-center">
                {coverImage ? (
                  <img 
                    src={coverImage} 
                    alt={post.data.title}
                    class="w-full h-full object-cover"
                    loading="lazy"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                  />
                ) : null}
                <!-- å ä½å›¾æ ‡ -->
                <div class={`${coverImage ? 'hidden' : 'flex'} items-center justify-center w-full h-full`}>
                  <span class="text-lg">ğŸ“„</span>
                </div>
              </div>
              
              <!-- æ–‡å­—å†…å®¹ -->
              <div class="flex-1 min-w-0">
                <span class="text-sm font-medium leading-tight text-left block line-clamp-2">
                  {post.data.title}
                </span>
                <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                  {getRelativeTime(displayDate)}
                </span>
              </div>
            </div>
          </ButtonLink>
        );
      })
    ) : (
      <div class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
        {posts.length === 0 ? 'æœªæ‰¾åˆ°æ–‡ç« å†…å®¹' : `æš‚æ— æ–‡ç« æ›´æ–°ï¼ˆæ€»æ–‡ç« æ•°: ${posts.length}ï¼Œå·²å‘å¸ƒ: ${publishedPosts.length}ï¼‰`}
      </div>
    )}
</WidgetLayout>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
